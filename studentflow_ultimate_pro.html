<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StudentFlow Ultimate Pro | AI-Powered Student Wellness</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0b0f1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="StudentFlow">
    <meta name="description" content="Application de gestion du bien-√™tre √©tudiant avec IA">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- BUNDLED LIBRARIES (offline-first) -->
    <script src="./tailwind.min.js"></script>
    <script src="./chart.min.js"></script>
    <script src="./lucide.min.js"></script>
    <script src="./jspdf.min.js"></script>
    <script src="./confetti.min.js"></script>
    <!-- Fallback font stack (no CDN needed) -->
    <style>
        @font-face {
            font-family: 'Plus Jakarta Sans';
            font-style: normal;
            font-weight: 400 900;
            font-display: swap;
            src: local('Plus Jakarta Sans'), local('PlusJakartaSans');
        }
    </style>
    <style>
        :root { 
            --p: #6366f1; 
            --s: #f43f5e; 
            --bg: #0b0f1a;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
        }
        
        /* LIGHT MODE */
        body.light-mode {
            --bg: #f8fafc;
            --glass: rgba(0, 0, 0, 0.02);
            --border: rgba(0, 0, 0, 0.08);
            color: #1e293b;
        }
        body.light-mode .bg-glow {
            background: radial-gradient(circle at 50% -20%, #e0e7ff 0%, transparent 50%), 
                        radial-gradient(circle at 0% 100%, #f1f5f9 0%, transparent 50%);
        }
        body.light-mode .glass { background: var(--glass); border-color: var(--border); }
        body.light-mode .text-slate-400, body.light-mode .text-slate-500 { color: #64748b; }
        body.light-mode .text-slate-300 { color: #475569; }
        body.light-mode input, body.light-mode .slot-empty { background: rgba(0,0,0,0.02); border-color: rgba(0,0,0,0.1); }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            color: #fff; 
            scroll-behavior: smooth;
            transition: all 0.5s ease;
            overflow-x: hidden;
        }
        
        body.safe-mode {
            background: linear-gradient(135deg, #4a1f1f 0%, #0b0f1a 100%);
        }
        
        .glass { 
            background: var(--glass); 
            backdrop-filter: blur(12px); 
            border: 1px solid var(--border); 
            border-radius: 24px;
            transition: all 0.3s ease;
        }
        
        .glass:hover {
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
        }
        
        .bg-glow { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: radial-gradient(circle at 50% -20%, #1e1b4b 0%, transparent 50%), 
                        radial-gradient(circle at 0% 100%, #111827 0%, transparent 50%); 
            z-index: -1;
            transition: all 0.5s ease;
        }
        
        .slot { 
            height: 55px; 
            border-radius: 12px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 1px solid rgba(255,255,255,0.05); 
            font-size: 10px; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            padding: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .slot::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .slot:hover::after { opacity: 1; }
        
        .type-cours { background: linear-gradient(135deg, #6366f1, #4338ca) !important; color: white; border: none; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .type-revisions { background: linear-gradient(135deg, #f59e0b, #d97706) !important; color: white; border: none; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
        .type-repos { background: linear-gradient(135deg, #10b981, #059669) !important; color: white; border: none; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .type-sport { background: linear-gradient(135deg, #f43f5e, #e11d48) !important; color: white; border: none; box-shadow: 0 4px 15px rgba(244, 63, 94, 0.4); }
        .type-social { background: linear-gradient(135deg, #a855f7, #7c3aed) !important; color: white; border: none; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.4); }
        .type-admin { background: linear-gradient(135deg, #64748b, #475569) !important; color: white; border: none; box-shadow: 0 4px 15px rgba(100, 116, 139, 0.4); }
        .type-repas { background: linear-gradient(135deg, #f97316, #ea580c) !important; color: white; border: none; box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4); }
        
        .slot-empty { 
            background: rgba(255,255,255,0.02); 
            color: rgba(255,255,255,0.3); 
            border: 1px dashed rgba(255,255,255,0.15);
            font-size: 1.2rem;
        }
        
        .slot-empty:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--p);
            color: var(--p);
            transform: scale(1.05);
        }
        
        .nav-active { 
            color: #6366f1 !important; 
            background: rgba(99, 102, 241, 0.15);
            border-left: 3px solid #6366f1;
        }
        
        .tab-pane { display: none; animation: slideUp 0.4s ease-out; }
        .tab-pane.active { display: block; }
        
        .type-btn { transition: all 0.2s; opacity: 0.4; border: 2px solid transparent; cursor: pointer; }
        .type-btn.selected { opacity: 1; border-color: white; transform: scale(1.05); }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); } 50% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.6); } }
        
        .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
        .animate-shake { animation: shake 0.5s ease-in-out; }
        .animate-glow { animation: glow 2s ease-in-out infinite; }
        
        .stat-number {
            background: linear-gradient(135deg, #6366f1, #f43f5e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .streak-flame { animation: flicker 1.5s ease-in-out infinite; }
        @keyframes flicker { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.1); } }
        
        .safe-mode-alert { animation: alertPulse 2s ease-in-out infinite; }
        @keyframes alertPulse { 0%, 100% { background: rgba(239, 68, 68, 0.1); } 50% { background: rgba(239, 68, 68, 0.2); } }
        
        /* HEATMAP */
        .heatmap-cell { transition: all 0.3s; }
        .heat-0 { background: rgba(99, 102, 241, 0.1); }
        .heat-1 { background: rgba(99, 102, 241, 0.3); }
        .heat-2 { background: rgba(99, 102, 241, 0.5); }
        .heat-3 { background: rgba(99, 102, 241, 0.7); }
        .heat-4 { background: rgba(99, 102, 241, 0.9); }
        
        /* MOBILE BOTTOM NAV */
        @media (max-width: 768px) {
            .desktop-nav { display: none !important; }
            .mobile-nav { display: flex !important; }
            main { margin-left: 0 !important; padding-bottom: 100px !important; }
        }
        @media (min-width: 769px) {
            .mobile-nav { display: none !important; }
        }
        
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(11, 15, 26, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 8px 16px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        
        .mobile-nav button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.2s;
            color: #64748b;
        }
        
        .mobile-nav button.active {
            color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }
        
        .mobile-nav button span {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        /* Touch Feedback */
        .touch-feedback {
            position: relative;
            overflow: hidden;
        }
        
        .touch-feedback::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(255,255,255,0.2) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .touch-feedback:active::before { opacity: 1; }
        
        /* Progress Ring */
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Custom Range Slider */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4);
            transition: transform 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div class="bg-glow"></div>

    <!-- Safe Mode Banner -->
    <div id="safe-mode-banner" class="hidden fixed top-0 left-0 right-0 z-[60] safe-mode-alert p-4 border-b-2 border-red-500">
        <div class="max-w-7xl mx-auto">
            <div class="flex items-center justify-between gap-4 flex-wrap">
                <div class="flex items-center gap-4">
                    <div class="text-center">
                        <p id="burnout-score" class="text-2xl font-black text-red-500">--</p>
                        <p class="text-[8px] text-slate-500 uppercase">Score</p>
                    </div>
                    <div class="h-10 w-px bg-white/20"></div>
                    <div>
                        <p class="font-black text-sm">üö® SAFE MODE ACTIV√â</p>
                        <div id="safe-mode-reasons" class="text-[10px] text-slate-400 mt-1"></div>
                    </div>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="reduceLoad(20)" class="px-3 py-2 bg-orange-500/20 text-orange-400 rounded-lg text-[10px] font-bold hover:bg-orange-500/30 touch-feedback">
                        üìâ -20% charge
                    </button>
                    <button onclick="convertRevisionsToRest(50)" class="px-3 py-2 bg-amber-500/20 text-amber-400 rounded-lg text-[10px] font-bold hover:bg-amber-500/30 touch-feedback">
                        üõ°Ô∏è 50% ‚Üí repos
                    </button>
                    <button onclick="convertRevisionsToRest(100)" class="px-3 py-2 bg-emerald-500/20 text-emerald-400 rounded-lg text-[10px] font-bold hover:bg-emerald-500/30 touch-feedback">
                        ‚úÖ Tout ‚Üí repos
                    </button>
                    <button onclick="dismissSafeMode()" class="px-3 py-2 bg-slate-500/20 text-slate-400 rounded-lg text-[10px] font-bold hover:bg-slate-500/30 touch-feedback">
                        ‚úï 24h
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Desktop Navigation -->
    <nav class="desktop-nav fixed left-0 top-0 h-full w-20 md:w-64 glass m-0 rounded-none border-y-0 border-l-0 z-50 flex flex-col py-6 overflow-y-auto overflow-x-hidden">
        <div class="flex items-center gap-3 mb-4 px-4">
            <div class="p-3 bg-indigo-600 rounded-2xl mx-auto md:mx-0 shadow-lg shadow-indigo-500/50 animate-glow">
                <i data-lucide="zap" class="text-white w-6 h-6"></i>
            </div>
            <div class="hidden md:block">
                <h1 class="font-extrabold text-xl">STUDENT<span class="text-indigo-500">FLOW</span></h1>
                <p class="text-[8px] text-slate-600 font-bold uppercase">Ultimate Pro</p>
            </div>
        </div>
        
        <!-- Theme Toggle -->
        <div class="px-4 mb-4">
            <button onclick="toggleTheme()" class="w-full glass p-3 rounded-xl flex items-center justify-center gap-2 hover:bg-white/10 transition touch-feedback">
                <i data-lucide="sun" class="w-4 h-4" id="theme-icon"></i>
                <span class="hidden md:block text-xs font-bold">Th√®me</span>
            </button>
        </div>
        
        <!-- Gamification Panel -->
        <div class="hidden md:block w-full px-4 mb-4">
            <div class="glass p-4 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-xs text-slate-400">Niveau</span>
                    <div class="flex items-center gap-2">
                        <div class="w-16 h-2 bg-slate-800 rounded-full overflow-hidden">
                            <div id="level-progress" class="h-full bg-indigo-500 transition-all" style="width: 0%"></div>
                        </div>
                        <span id="user-level" class="text-lg font-black text-indigo-500">1</span>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-slate-400">Sagesse</span>
                    <span id="wisdom-points" class="text-lg font-black text-amber-500">0</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="streak-flame text-2xl">üî•</span>
                    <div class="flex-1">
                        <p class="text-xs text-slate-400">Streak</p>
                        <p id="streak-count" class="text-sm font-black">0j</p>
                    </div>
                    <div id="streak-bonus" class="hidden px-2 py-1 bg-amber-500/20 text-amber-500 text-[8px] font-bold rounded-full">
                        BONUS x2
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sound Toggle -->
        <div class="px-4 mb-4 space-y-2">
            <button onclick="toggleSound()" id="sound-btn" class="w-full glass p-3 rounded-xl flex items-center justify-center gap-2 hover:bg-white/10 transition touch-feedback">
                <i data-lucide="volume-2" class="w-4 h-4" id="sound-icon"></i>
                <span class="hidden md:block text-xs font-bold">Son</span>
            </button>
            <button onclick="testSound()" class="w-full glass p-2 rounded-xl flex items-center justify-center gap-2 hover:bg-white/10 transition touch-feedback text-emerald-400">
                <i data-lucide="play-circle" class="w-3 h-3"></i>
                <span class="hidden md:block text-[10px] font-bold">Tester</span>
            </button>
        </div>
        
        <!-- Navigation Buttons -->
        <div class="flex flex-col gap-2 w-full px-4 flex-1">
            <button onclick="switchTab('sched')" id="btn-sched" class="nav-active flex items-center gap-4 p-4 rounded-2xl w-full touch-feedback">
                <i data-lucide="calendar" class="w-5 h-5"></i> 
                <span class="hidden md:block font-bold uppercase text-[10px]">Planning</span>
            </button>
            <button onclick="switchTab('dash')" id="btn-dash" class="flex items-center gap-4 p-4 rounded-2xl w-full text-slate-400 touch-feedback">
                <i data-lucide="layout-grid" class="w-5 h-5"></i> 
                <span class="hidden md:block font-bold uppercase text-[10px]">Dashboard</span>
            </button>
            <button onclick="switchTab('analytics')" id="btn-analytics" class="flex items-center gap-4 p-4 rounded-2xl w-full text-slate-400 touch-feedback">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i> 
                <span class="hidden md:block font-bold uppercase text-[10px]">Analytics</span>
            </button>
            <button onclick="switchTab('focus')" id="btn-focus" class="flex items-center gap-4 p-4 rounded-2xl w-full text-slate-400 touch-feedback">
                <i data-lucide="target" class="w-5 h-5"></i> 
                <span class="hidden md:block font-bold uppercase text-[10px]">Focus</span>
            </button>
            <button onclick="switchTab('log')" id="btn-log" class="flex items-center gap-4 p-4 rounded-2xl w-full text-slate-400 touch-feedback">
                <i data-lucide="heart" class="w-5 h-5"></i> 
                <span class="hidden md:block font-bold uppercase text-[10px]">Journal</span>
            </button>
            <button onclick="switchTab('goals')" id="btn-goals" class="flex items-center gap-4 p-4 rounded-2xl w-full text-slate-400 touch-feedback">
                <i data-lucide="flag" class="w-5 h-5"></i> 
                <span class="hidden md:block font-bold uppercase text-[10px]">Objectifs</span>
            </button>
            <button onclick="switchTab('wellness')" id="btn-wellness" class="flex items-center gap-4 p-4 rounded-2xl w-full text-slate-400 touch-feedback">
                <i data-lucide="activity" class="w-5 h-5"></i> 
                <span class="hidden md:block font-bold uppercase text-[10px]">Bio-Hack</span>
            </button>
        </div>
        
        <!-- Bottom Actions -->
        <div class="px-4 space-y-2">
            <button onclick="openDataModal()" class="w-full flex items-center justify-center gap-2 p-3 rounded-xl text-slate-400 hover:bg-white/5 text-xs font-bold touch-feedback">
                <i data-lucide="database" class="w-4 h-4"></i>
                <span class="hidden md:block">Donn√©es</span>
            </button>
            <button onclick="resetAll()" class="w-full flex items-center justify-center gap-2 p-3 rounded-xl text-slate-400 hover:text-red-500 text-xs font-bold touch-feedback">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
                <span class="hidden md:block">Reset</span>
            </button>
        </div>
    </nav>

    <!-- Mobile Bottom Navigation -->
    <div class="mobile-nav">
        <button onclick="switchTab('sched')" id="mob-sched" class="active">
            <i data-lucide="calendar" class="w-5 h-5"></i>
            <span>Planning</span>
        </button>
        <button onclick="switchTab('dash')" id="mob-dash">
            <i data-lucide="layout-grid" class="w-5 h-5"></i>
            <span>Stats</span>
        </button>
        <button onclick="switchTab('focus')" id="mob-focus">
            <i data-lucide="target" class="w-5 h-5"></i>
            <span>Focus</span>
        </button>
        <button onclick="switchTab('log')" id="mob-log">
            <i data-lucide="heart" class="w-5 h-5"></i>
            <span>Journal</span>
        </button>
        <button onclick="switchTab('wellness')" id="mob-wellness">
            <i data-lucide="activity" class="w-5 h-5"></i>
            <span>Zen</span>
        </button>
    </div>
    
    <!-- Mobile More Menu -->
    <div id="mobile-more-menu" class="hidden fixed bottom-20 right-4 glass p-4 z-[101] space-y-2" style="border-radius: 16px;">
        <button onclick="switchTab('analytics'); closeMobileMore()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/10 text-left">
            <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-500"></i>
            <span class="font-bold text-sm">Analytics</span>
        </button>
        <button onclick="switchTab('goals'); closeMobileMore()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/10 text-left">
            <i data-lucide="flag" class="w-5 h-5 text-amber-500"></i>
            <span class="font-bold text-sm">Objectifs</span>
        </button>
        <button onclick="openDataModal(); closeMobileMore()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/10 text-left">
            <i data-lucide="database" class="w-5 h-5 text-emerald-500"></i>
            <span class="font-bold text-sm">Donn√©es</span>
        </button>
    </div>

    <main class="ml-20 md:ml-64 p-4 md:p-8 pb-20">
        <header class="mb-8 flex flex-wrap justify-between items-start gap-4">
            <div>
                <h2 class="text-3xl md:text-4xl font-black italic">StudentFlow Pro</h2>
                <p class="text-slate-500 font-bold uppercase text-[10px]">AI-Powered Wellness Platform</p>
            </div>
            <div class="flex gap-2">
                <button onclick="requestNotificationPermission()" class="glass px-4 py-2 text-xs font-bold flex items-center gap-2 hover:bg-white/10 touch-feedback">
                    <i data-lucide="bell" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Notifs</span>
                </button>
                <button onclick="quickNote()" class="glass px-4 py-2 text-xs font-bold flex items-center gap-2 hover:bg-white/10 touch-feedback">
                    <i data-lucide="sticky-note" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Note</span>
                </button>
                <button onclick="openNotesModal()" class="glass px-4 py-2 text-xs font-bold flex items-center gap-2 hover:bg-white/10 touch-feedback">
                    <i data-lucide="book-open" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Mes Notes</span>
                </button>
            </div>
        </header>

        <!-- PLANNING TAB -->
        <div id="sched" class="tab-pane active space-y-6">
            <!-- AI Prediction Card -->
            <div class="glass p-6 bg-gradient-to-br from-purple-500/10 to-transparent border-purple-500/30">
                <div class="flex items-start gap-4">
                    <div class="bg-purple-600/20 p-4 rounded-2xl animate-pulse-slow">
                        <i data-lucide="sparkles" class="w-8 h-8 text-purple-400"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-black mb-2">üîÆ Pr√©diction IA</h3>
                        <p id="prediction-text" class="text-slate-300 text-sm">Analyse en cours...</p>
                    </div>
                </div>
            </div>
            
            <!-- Planning Grid -->
            <div class="glass p-4 md:p-8">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                    <h2 class="text-2xl font-black">üìÖ Planning Semaine</h2>
                    <div class="flex gap-2 flex-wrap">
                        <div class="relative">
                            <button onclick="toggleTemplateMenu()" class="px-4 py-2 bg-indigo-500/20 text-indigo-400 font-bold text-[10px] uppercase rounded-xl hover:bg-indigo-500/30 touch-feedback flex items-center gap-1">
                                <i data-lucide="layout-template" class="w-3 h-3"></i>
                                Templates
                            </button>
                            <div id="template-menu" class="hidden absolute top-full right-0 mt-2 glass p-2 z-50 min-w-[150px]" style="border-radius: 12px;">
                                <button onclick="applyTemplate('normal'); toggleTemplateMenu();" class="w-full text-left px-3 py-2 text-xs font-bold hover:bg-white/10 rounded-lg">üìö Semaine Type</button>
                                <button onclick="applyTemplate('exam'); toggleTemplateMenu();" class="w-full text-left px-3 py-2 text-xs font-bold hover:bg-white/10 rounded-lg">üìù Semaine Examens</button>
                                <button onclick="applyTemplate('light'); toggleTemplateMenu();" class="w-full text-left px-3 py-2 text-xs font-bold hover:bg-white/10 rounded-lg">üå¥ Semaine Light</button>
                                <hr class="border-white/10 my-2">
                                <button onclick="saveAsTemplate(); toggleTemplateMenu();" class="w-full text-left px-3 py-2 text-xs font-bold hover:bg-white/10 rounded-lg text-amber-400">üíæ Sauvegarder actuel</button>
                            </div>
                        </div>
                        <button onclick="addDemoData()" class="px-4 py-2 bg-white/10 text-white font-bold text-[10px] uppercase rounded-xl hover:bg-white hover:text-black transition touch-feedback">
                            D√©mo
                        </button>
                        <button onclick="clearPlanning()" class="px-4 py-2 bg-red-500/10 text-red-400 font-bold text-[10px] uppercase rounded-xl hover:bg-red-500/20 touch-feedback">
                            Vider
                        </button>
                    </div>
                </div>
                
                <!-- Raccourcis clavier hint -->
                <p class="text-[10px] text-slate-500 mb-4 hidden md:block">üí° Raccourcis: N=Note, F=Focus, J=Journal, P=Planning, A=Analytics, T=Th√®me, S=Son (focus), Espace=Pomodoro, Esc=Fermer</p>
                
                <div class="overflow-x-auto -mx-4 px-4">
                    <div class="min-w-[800px] grid grid-cols-8 gap-2 p-4 bg-white/[0.02] rounded-2xl">
                        <div class="h-10"></div>
                        <div class="text-center font-black text-[10px] text-slate-500">LUN</div>
                        <div class="text-center font-black text-[10px] text-slate-500">MAR</div>
                        <div class="text-center font-black text-[10px] text-slate-500">MER</div>
                        <div class="text-center font-black text-[10px] text-slate-500">JEU</div>
                        <div class="text-center font-black text-[10px] text-slate-500">VEN</div>
                        <div class="text-center font-black text-[10px] text-amber-400">SAM</div>
                        <div class="text-center font-black text-[10px] text-amber-400">DIM</div>
                        <div id="grid-root" class="contents"></div>
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="flex flex-wrap gap-4 mt-6 justify-center">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-gradient-to-r from-indigo-600 to-indigo-800"></div>
                        <span class="text-xs text-slate-400">Cours</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-gradient-to-r from-amber-500 to-amber-700"></div>
                        <span class="text-xs text-slate-400">R√©vision</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-gradient-to-r from-emerald-500 to-emerald-700"></div>
                        <span class="text-xs text-slate-400">Repos</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="dash" class="tab-pane space-y-6">
            <!-- Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass p-6 text-center">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-2">Charge</p>
                    <span id="h-count" class="text-4xl md:text-5xl font-black stat-number">0</span>
                    <p class="text-[10px] text-slate-500 mt-1">heures</p>
                </div>
                <div class="glass p-6 text-center">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-2">Stress</p>
                    <span id="s-count" class="text-4xl md:text-5xl font-black stat-number">--</span>
                    <div class="w-full bg-slate-800 h-1 rounded-full mt-2">
                        <div id="stress-bar" class="h-full bg-pink-500 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>
                <div class="glass p-6 text-center">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-2">Sommeil</p>
                    <span id="sleep-avg" class="text-4xl md:text-5xl font-black stat-number">--</span>
                    <p class="text-[10px] text-slate-500 mt-1">h/nuit</p>
                </div>
                <div class="glass p-6 text-center bg-gradient-to-br from-amber-500/10">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-2">Sagesse</p>
                    <span id="wisdom-display" class="text-4xl md:text-5xl font-black text-amber-500">0</span>
                    <p class="text-[10px] text-slate-500 mt-1">points</p>
                </div>
            </div>

            <!-- Chronotype Analysis -->
            <div class="glass p-6 border-indigo-500/30">
                <div class="flex items-center gap-3 mb-4">
                    <i data-lucide="brain" class="w-6 h-6 text-indigo-500"></i>
                    <h3 class="text-lg font-black uppercase">üß† Chronotype</h3>
                </div>
                <div id="chronotype-analysis" class="text-slate-400 text-sm">
                    Remplis 3 jours pour analyse...
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 glass p-6 h-[350px]">
                    <h4 class="text-sm font-bold mb-4 text-slate-400">√âvolution 7 jours</h4>
                    <canvas id="main-chart"></canvas>
                </div>
                <div class="glass p-6 flex flex-col">
                    <div class="flex items-center gap-3 mb-4">
                        <i data-lucide="sparkles" class="w-5 h-5 text-indigo-500"></i> 
                        <span class="font-black text-xs uppercase">IA Coach</span>
                    </div>
                    <p id="ai-insight" class="text-slate-300 text-sm mb-4 flex-1">En attente de donn√©es...</p>
                    <div id="ai-tags" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics" class="tab-pane space-y-6">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                <h2 class="text-2xl font-black">üìä Analytics Avanc√©s</h2>
                <button onclick="shareStats()" class="glass px-4 py-2 text-xs font-bold flex items-center gap-2 hover:bg-white/10 touch-feedback">
                    <i data-lucide="share-2" class="w-4 h-4"></i>
                    Partager
                </button>
            </div>
            
            <!-- Monthly Summary Card -->
            <div class="glass p-6 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 border-indigo-500/30">
                <div class="flex items-center gap-3 mb-4">
                    <i data-lucide="calendar-days" class="w-6 h-6 text-indigo-500"></i>
                    <h3 class="font-black uppercase text-sm">Bilan du Mois</h3>
                    <span class="ml-auto text-xs text-slate-400" id="current-month">--</span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="text-center">
                        <p class="text-3xl font-black text-indigo-500" id="month-entries">0</p>
                        <p class="text-[10px] text-slate-400">Entr√©es Journal</p>
                    </div>
                    <div class="text-center">
                        <p class="text-3xl font-black text-emerald-500" id="month-focus">0h</p>
                        <p class="text-[10px] text-slate-400">Focus Total</p>
                    </div>
                    <div class="text-center">
                        <p class="text-3xl font-black text-amber-500" id="month-avg-stress">--</p>
                        <p class="text-[10px] text-slate-400">Stress Moy.</p>
                    </div>
                    <div class="text-center">
                        <p class="text-3xl font-black text-pink-500" id="month-avg-sleep">--</p>
                        <p class="text-[10px] text-slate-400">Sommeil Moy.</p>
                    </div>
                    <div class="text-center">
                        <p class="text-3xl font-black text-purple-500" id="month-score">--</p>
                        <p class="text-[10px] text-slate-400">Score Sant√©</p>
                    </div>
                </div>
                <!-- Progress Bar -->
                <div class="mt-4">
                    <div class="flex justify-between text-[10px] text-slate-400 mb-1">
                        <span>Score Sant√© Global</span>
                        <span id="health-score-percent">0%</span>
                    </div>
                    <div class="h-3 bg-white/10 rounded-full overflow-hidden">
                        <div id="health-score-bar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Radar -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass p-6">
                    <h3 class="text-sm font-bold mb-4 text-slate-400">Radar de Performance</h3>
                    <div class="h-[300px]">
                        <canvas id="radar-chart"></canvas>
                    </div>
                </div>
                
                <!-- Weekly Heatmap -->
                <div class="glass p-6">
                    <h3 class="text-sm font-bold mb-4 text-slate-400">Heatmap Activit√©</h3>
                    <div id="heatmap" class="grid grid-cols-7 gap-1"></div>
                    <!-- Mood Calendar -->
                    <h4 class="text-sm font-bold mt-6 mb-3 text-slate-400">Humeurs du Mois</h4>
                    <div id="mood-calendar" class="grid grid-cols-7 gap-1"></div>
                </div>
            </div>
            
            <!-- Trends -->
            <div class="glass p-6">
                <h3 class="text-sm font-bold mb-4 text-slate-400">Tendances 30 jours</h3>
                <div class="h-[250px]">
                    <canvas id="trend-chart"></canvas>
                </div>
            </div>
            
            <!-- Comparisons -->
            <div class="glass p-6">
                <h3 class="text-sm font-bold mb-4 text-slate-400">Comparaison Semaines</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-white/5 rounded-xl">
                        <p class="text-[10px] text-slate-400 uppercase mb-2">Cette Semaine</p>
                        <div class="flex items-center gap-2">
                            <span class="text-2xl font-black" id="this-week-stress">--</span>
                            <span class="text-sm text-slate-400">stress moy.</span>
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-2xl font-black" id="this-week-sleep">--</span>
                            <span class="text-sm text-slate-400">h sommeil moy.</span>
                        </div>
                    </div>
                    <div class="p-4 bg-white/5 rounded-xl">
                        <p class="text-[10px] text-slate-400 uppercase mb-2">Semaine Pr√©c√©dente</p>
                        <div class="flex items-center gap-2">
                            <span class="text-2xl font-black" id="last-week-stress">--</span>
                            <span class="text-sm text-slate-400">stress moy.</span>
                            <span id="stress-change" class="text-xs font-bold"></span>
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-2xl font-black" id="last-week-sleep">--</span>
                            <span class="text-sm text-slate-400">h sommeil moy.</span>
                            <span id="sleep-change" class="text-xs font-bold"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass p-4 text-center">
                    <p class="text-3xl font-black text-indigo-500" id="stat-best-day">--</p>
                    <p class="text-[10px] text-slate-400 uppercase">Meilleur jour</p>
                </div>
                <div class="glass p-4 text-center">
                    <p class="text-3xl font-black text-emerald-500" id="stat-total-focus">0</p>
                    <p class="text-[10px] text-slate-400 uppercase">Sessions Focus</p>
                </div>
                <div class="glass p-4 text-center">
                    <p class="text-3xl font-black text-amber-500" id="stat-avg-sleep">--</p>
                    <p class="text-[10px] text-slate-400 uppercase">Sommeil moy.</p>
                </div>
                <div class="glass p-4 text-center">
                    <p class="text-3xl font-black text-pink-500" id="stat-stress-trend">--</p>
                    <p class="text-[10px] text-slate-400 uppercase">Tendance stress</p>
                </div>
            </div>
        </div>

        <!-- FOCUS MODE TAB -->
        <div id="focus" class="tab-pane">
            <div class="max-w-2xl mx-auto space-y-6">
                <div class="glass p-8 md:p-12 text-center">
                    <h2 class="text-3xl font-black mb-2">üéØ FOCUS MODE</h2>
                    <p id="focus-mode-label" class="text-slate-400 text-sm mb-4">Technique Pomodoro</p>
                    
                    <!-- Session Tag -->
                    <div class="mb-6">
                        <input type="text" id="focus-tag" placeholder="Tag: Maths, Projet..." 
                            class="bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-center text-sm outline-none focus:border-indigo-500 w-48">
                    </div>
                    
                    <!-- Timer Display -->
                    <div class="relative inline-block mb-6">
                        <svg class="progress-ring w-48 h-48 md:w-64 md:h-64">
                            <circle class="text-slate-800" stroke="currentColor" stroke-width="8" fill="transparent" r="90" cx="50%" cy="50%"/>
                            <circle id="progress-circle" class="progress-ring__circle text-indigo-500" stroke="currentColor" stroke-width="8" fill="transparent" r="90" cx="50%" cy="50%" stroke-dasharray="565.48" stroke-dashoffset="0"/>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-5xl md:text-6xl font-black" id="timer-display">25:00</span>
                            <span id="timer-phase" class="text-xs text-slate-500 mt-2">TRAVAIL</span>
                        </div>
                    </div>
                    
                    <!-- Session Progress (dots) -->
                    <div class="flex justify-center gap-2 mb-6">
                        <div id="session-dot-1" class="w-3 h-3 rounded-full bg-slate-700"></div>
                        <div id="session-dot-2" class="w-3 h-3 rounded-full bg-slate-700"></div>
                        <div id="session-dot-3" class="w-3 h-3 rounded-full bg-slate-700"></div>
                        <div id="session-dot-4" class="w-3 h-3 rounded-full bg-slate-700"></div>
                        <span class="text-xs text-slate-500 ml-2">‚Üí Long break</span>
                    </div>
                    
                    <!-- Timer Controls -->
                    <div class="flex gap-4 justify-center flex-wrap">
                        <button onclick="startPomodoro()" id="start-btn" class="px-8 py-4 bg-indigo-600 rounded-2xl font-black uppercase text-sm hover:bg-indigo-500 transition touch-feedback">
                            <i data-lucide="play" class="w-5 h-5 inline mr-2"></i> Start
                        </button>
                        <button onclick="pausePomodoro()" class="px-8 py-4 bg-slate-700 rounded-2xl font-black uppercase text-sm hover:bg-slate-600 transition touch-feedback">
                            <i data-lucide="pause" class="w-5 h-5 inline mr-2"></i> Pause
                        </button>
                        <button onclick="resetPomodoro()" class="px-8 py-4 bg-red-500/20 text-red-500 rounded-2xl font-black uppercase text-sm hover:bg-red-500/30 transition touch-feedback">
                            <i data-lucide="rotate-ccw" class="w-5 h-5 inline mr-2"></i> Reset
                        </button>
                    </div>
                    
                    <!-- Session Counter -->
                    <div class="mt-8 flex items-center justify-center gap-4 flex-wrap">
                        <div class="flex gap-2">
                            <span class="text-xs text-slate-400">Aujourd'hui:</span>
                            <span id="today-sessions" class="text-xs font-bold text-indigo-400">0</span>
                        </div>
                        <button onclick="openFocusHistory()" class="px-4 py-2 bg-white/5 rounded-xl text-xs font-bold hover:bg-white/10 touch-feedback flex items-center gap-2">
                            <i data-lucide="history" class="w-4 h-4"></i>
                            Historique
                        </button>
                    </div>
                </div>
                
                <!-- Ambient Sound -->
                <div class="glass p-4">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-bold">üéß Son Ambiant</span>
                        <button onclick="toggleAmbientSound()" id="ambient-toggle" class="px-4 py-2 bg-white/5 rounded-xl text-xs font-bold hover:bg-white/10 touch-feedback">
                            OFF
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="setAmbientSound('rain')" class="ambient-btn flex-1 p-3 rounded-xl text-center hover:bg-white/10 touch-feedback" data-sound="rain">
                            <span class="text-xl">üåßÔ∏è</span>
                            <p class="text-[10px] mt-1">Pluie</p>
                        </button>
                        <button onclick="setAmbientSound('forest')" class="ambient-btn flex-1 p-3 rounded-xl text-center hover:bg-white/10 touch-feedback" data-sound="forest">
                            <span class="text-xl">üå≤</span>
                            <p class="text-[10px] mt-1">For√™t</p>
                        </button>
                        <button onclick="setAmbientSound('cafe')" class="ambient-btn flex-1 p-3 rounded-xl text-center hover:bg-white/10 touch-feedback" data-sound="cafe">
                            <span class="text-xl">‚òï</span>
                            <p class="text-[10px] mt-1">Caf√©</p>
                        </button>
                        <button onclick="setAmbientSound('white')" class="ambient-btn flex-1 p-3 rounded-xl text-center hover:bg-white/10 touch-feedback" data-sound="white">
                            <span class="text-xl">üìª</span>
                            <p class="text-[10px] mt-1">Blanc</p>
                        </button>
                    </div>
                </div>
                
                <!-- Quick Timers -->
                <div class="grid grid-cols-4 gap-3">
                    <button onclick="setCustomTimer(15)" class="glass p-3 text-center hover:bg-white/5 touch-feedback">
                        <p class="text-xl font-black">15</p>
                        <p class="text-[8px] text-slate-400">quick</p>
                    </button>
                    <button onclick="setCustomTimer(25)" class="glass p-3 text-center hover:bg-white/5 touch-feedback border-indigo-500/50">
                        <p class="text-xl font-black text-indigo-500">25</p>
                        <p class="text-[8px] text-slate-400">standard</p>
                    </button>
                    <button onclick="setCustomTimer(45)" class="glass p-3 text-center hover:bg-white/5 touch-feedback">
                        <p class="text-xl font-black">45</p>
                        <p class="text-[8px] text-slate-400">deep</p>
                    </button>
                    <button onclick="setCustomTimer(90)" class="glass p-3 text-center hover:bg-white/5 touch-feedback">
                        <p class="text-xl font-black">90</p>
                        <p class="text-[8px] text-slate-400">ultra</p>
                    </button>
                </div>
                
                <!-- Exam Mode -->
                <div class="glass p-4">
                    <h3 class="text-sm font-bold mb-3">üìù Mode Examen</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="startExamMode(60)" class="p-3 bg-amber-500/20 text-amber-400 rounded-xl text-center hover:bg-amber-500/30 touch-feedback">
                            <p class="text-xl font-black">1h</p>
                            <p class="text-[8px]">Contr√¥le</p>
                        </button>
                        <button onclick="startExamMode(120)" class="p-3 bg-orange-500/20 text-orange-400 rounded-xl text-center hover:bg-orange-500/30 touch-feedback">
                            <p class="text-xl font-black">2h</p>
                            <p class="text-[8px]">Partiel</p>
                        </button>
                        <button onclick="startExamMode(240)" class="p-3 bg-red-500/20 text-red-400 rounded-xl text-center hover:bg-red-500/30 touch-feedback">
                            <p class="text-xl font-black">4h</p>
                            <p class="text-[8px]">Concours</p>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- JOURNAL TAB -->
        <div id="log" class="tab-pane max-w-xl mx-auto">
            <div class="glass p-6 md:p-8 space-y-6">
                <div class="text-center">
                    <h2 class="text-2xl font-black italic uppercase">Journal Quotidien</h2>
                    <p class="text-xs text-slate-400 mt-2">Synchronise tes m√©triques de bien-√™tre</p>
                </div>
                
                <div class="space-y-6">
                    <!-- Quick Stress Buttons -->
                    <div>
                        <label class="block text-center text-[10px] font-black uppercase mb-3 text-slate-400">Stress (clic rapide)</label>
                        <div class="flex gap-2 justify-center flex-wrap">
                            <button onclick="setQuickStress(1)" class="quick-stress px-4 py-2 rounded-xl text-sm font-bold bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/30">1-2</button>
                            <button onclick="setQuickStress(3)" class="quick-stress px-4 py-2 rounded-xl text-sm font-bold bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/30">3-4</button>
                            <button onclick="setQuickStress(5)" class="quick-stress px-4 py-2 rounded-xl text-sm font-bold bg-amber-500/20 text-amber-400 hover:bg-amber-500/30">5-6</button>
                            <button onclick="setQuickStress(7)" class="quick-stress px-4 py-2 rounded-xl text-sm font-bold bg-orange-500/20 text-orange-400 hover:bg-orange-500/30">7-8</button>
                            <button onclick="setQuickStress(9)" class="quick-stress px-4 py-2 rounded-xl text-sm font-bold bg-red-500/20 text-red-400 hover:bg-red-500/30">9-10</button>
                        </div>
                        <input type="range" id="in-stress" min="0" max="10" value="5" class="w-full mt-3">
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-lg">üòå</span>
                            <span id="stress-display" class="text-2xl font-black text-indigo-500">5</span>
                            <span class="text-lg">üò∞</span>
                        </div>
                    </div>
                    
                    <!-- Quick Sleep Buttons -->
                    <div>
                        <label class="block text-center text-[10px] font-black uppercase mb-3 text-slate-400">Sommeil (clic rapide)</label>
                        <div class="flex gap-2 justify-center flex-wrap mb-3">
                            <button onclick="setQuickSleep(5)" class="quick-sleep px-4 py-2 rounded-xl text-sm font-bold bg-red-500/20 text-red-400 hover:bg-red-500/30">5h</button>
                            <button onclick="setQuickSleep(6)" class="quick-sleep px-4 py-2 rounded-xl text-sm font-bold bg-orange-500/20 text-orange-400 hover:bg-orange-500/30">6h</button>
                            <button onclick="setQuickSleep(7)" class="quick-sleep px-4 py-2 rounded-xl text-sm font-bold bg-amber-500/20 text-amber-400 hover:bg-amber-500/30">7h</button>
                            <button onclick="setQuickSleep(8)" class="quick-sleep px-4 py-2 rounded-xl text-sm font-bold bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/30">8h</button>
                            <button onclick="setQuickSleep(9)" class="quick-sleep px-4 py-2 rounded-xl text-sm font-bold bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/30">9h+</button>
                        </div>
                        <input type="number" id="in-sleep" placeholder="8.0" step="0.5" min="0" max="24"
                            class="w-full bg-white/5 border border-white/10 p-3 text-center text-3xl font-black outline-none focus:border-indigo-600 rounded-xl">
                    </div>
                    
                    <!-- Sleep Quality -->
                    <div>
                        <label class="block text-center text-[10px] font-black uppercase mb-3 text-slate-400">Qualit√© Sommeil</label>
                        <div class="flex justify-center gap-2">
                            <button onclick="setSleepQuality(1)" class="sleep-qual w-10 h-10 rounded-xl text-lg hover:bg-white/10" data-val="1">üò´</button>
                            <button onclick="setSleepQuality(2)" class="sleep-qual w-10 h-10 rounded-xl text-lg hover:bg-white/10" data-val="2">üòï</button>
                            <button onclick="setSleepQuality(3)" class="sleep-qual w-10 h-10 rounded-xl text-lg hover:bg-white/10 bg-white/10" data-val="3">üòê</button>
                            <button onclick="setSleepQuality(4)" class="sleep-qual w-10 h-10 rounded-xl text-lg hover:bg-white/10" data-val="4">üòä</button>
                            <button onclick="setSleepQuality(5)" class="sleep-qual w-10 h-10 rounded-xl text-lg hover:bg-white/10" data-val="5">üò¥</button>
                        </div>
                    </div>
                    
                    <!-- Mood Selector -->
                    <div>
                        <label class="block text-center text-[10px] font-black uppercase mb-3 text-slate-400">Humeur</label>
                        <div class="flex justify-center gap-3">
                            <button onclick="selectMood('üò¢')" class="mood-btn text-2xl p-2 rounded-xl hover:bg-white/10 transition">üò¢</button>
                            <button onclick="selectMood('üòê')" class="mood-btn text-2xl p-2 rounded-xl hover:bg-white/10 transition">üòê</button>
                            <button onclick="selectMood('üòä')" class="mood-btn text-2xl p-2 rounded-xl hover:bg-white/10 transition selected bg-white/10">üòä</button>
                            <button onclick="selectMood('üòÑ')" class="mood-btn text-2xl p-2 rounded-xl hover:bg-white/10 transition">üòÑ</button>
                            <button onclick="selectMood('üî•')" class="mood-btn text-2xl p-2 rounded-xl hover:bg-white/10 transition">üî•</button>
                        </div>
                    </div>
                    
                    <!-- Additional Metrics (collapsed by default) -->
                    <details class="glass p-4 rounded-xl">
                        <summary class="cursor-pointer text-sm font-bold text-slate-400">üìä M√©triques Avanc√©es</summary>
                        <div class="mt-4 space-y-4">
                            <!-- Caffeine -->
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-2">‚òï Caf√©ine (tasses)</label>
                                <div class="flex gap-2">
                                    <button onclick="setCaffeine(0)" class="caffeine-btn flex-1 py-2 rounded-lg text-sm font-bold bg-white/5 hover:bg-white/10" data-val="0">0</button>
                                    <button onclick="setCaffeine(1)" class="caffeine-btn flex-1 py-2 rounded-lg text-sm font-bold bg-white/5 hover:bg-white/10" data-val="1">1</button>
                                    <button onclick="setCaffeine(2)" class="caffeine-btn flex-1 py-2 rounded-lg text-sm font-bold bg-white/5 hover:bg-white/10" data-val="2">2</button>
                                    <button onclick="setCaffeine(3)" class="caffeine-btn flex-1 py-2 rounded-lg text-sm font-bold bg-white/5 hover:bg-white/10" data-val="3">3+</button>
                                </div>
                            </div>
                            
                            <!-- Exercise -->
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-2">üèÉ Activit√© Physique</label>
                                <div class="flex gap-2">
                                    <button onclick="setExercise('none')" class="exercise-btn flex-1 py-2 rounded-lg text-[10px] font-bold bg-white/5 hover:bg-white/10" data-val="none">Aucune</button>
                                    <button onclick="setExercise('light')" class="exercise-btn flex-1 py-2 rounded-lg text-[10px] font-bold bg-white/5 hover:bg-white/10" data-val="light">L√©g√®re</button>
                                    <button onclick="setExercise('moderate')" class="exercise-btn flex-1 py-2 rounded-lg text-[10px] font-bold bg-white/5 hover:bg-white/10" data-val="moderate">Mod√©r√©e</button>
                                    <button onclick="setExercise('intense')" class="exercise-btn flex-1 py-2 rounded-lg text-[10px] font-bold bg-white/5 hover:bg-white/10" data-val="intense">Intense</button>
                                </div>
                            </div>
                            
                            <!-- Screen Time -->
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-2">üì± Screen Time (heures)</label>
                                <input type="number" id="in-screen" placeholder="4" min="0" max="24" step="0.5"
                                    class="w-full bg-white/5 border border-white/10 p-2 rounded-lg text-sm outline-none focus:border-indigo-500">
                            </div>
                            
                            <!-- Symptoms -->
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-2">ü©∫ Sympt√¥mes</label>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="toggleSymptom('headache')" class="symptom-btn px-3 py-1 rounded-full text-[10px] font-bold bg-white/5 hover:bg-white/10" data-val="headache">ü§ï Mal de t√™te</button>
                                    <button onclick="toggleSymptom('fatigue')" class="symptom-btn px-3 py-1 rounded-full text-[10px] font-bold bg-white/5 hover:bg-white/10" data-val="fatigue">üò© Fatigue</button>
                                    <button onclick="toggleSymptom('anxiety')" class="symptom-btn px-3 py-1 rounded-full text-[10px] font-bold bg-white/5 hover:bg-white/10" data-val="anxiety">üò∞ Anxi√©t√©</button>
                                    <button onclick="toggleSymptom('backpain')" class="symptom-btn px-3 py-1 rounded-full text-[10px] font-bold bg-white/5 hover:bg-white/10" data-val="backpain">ü¶¥ Mal de dos</button>
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <!-- Quick Note -->
                    <div>
                        <label class="block text-center text-[10px] font-black uppercase mb-2 text-slate-400">Note (optionnel)</label>
                        <textarea id="in-note" rows="2" placeholder="Comment s'est pass√©e ta journ√©e ?" 
                            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm outline-none focus:border-indigo-600 resize-none"></textarea>
                    </div>
                    
                    <!-- AI Suggestion -->
                    <div id="journal-suggestion" class="hidden glass p-4 bg-purple-500/10 border-purple-500/30 rounded-xl">
                        <p class="text-sm text-purple-300" id="suggestion-text"></p>
                    </div>
                    
                    <button onclick="saveEntry()" class="w-full bg-indigo-600 py-4 rounded-2xl font-black text-sm uppercase hover:bg-indigo-500 transition touch-feedback">
                        üíæ Synchroniser
                    </button>
                </div>
            </div>
        </div>

        <!-- GOALS TAB -->
        <div id="goals" class="tab-pane max-w-2xl mx-auto space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-black">üéØ Objectifs</h2>
                <button onclick="addGoal()" class="glass px-4 py-2 text-sm font-bold hover:bg-white/10 touch-feedback">
                    + Ajouter
                </button>
            </div>
            
            <div id="goals-list" class="space-y-4">
                <!-- Goals will be inserted here -->
            </div>
            
            <!-- Weekly Summary -->
            <div class="glass p-6 bg-gradient-to-br from-emerald-500/10 to-transparent">
                <h3 class="font-bold mb-4">üìà R√©sum√© Hebdomadaire</h3>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-2xl font-black text-emerald-500" id="goals-completed">0</p>
                        <p class="text-[10px] text-slate-400">Compl√©t√©s</p>
                    </div>
                    <div>
                        <p class="text-2xl font-black text-amber-500" id="goals-progress">0</p>
                        <p class="text-[10px] text-slate-400">En cours</p>
                    </div>
                    <div>
                        <p class="text-2xl font-black text-indigo-500" id="goals-total">0</p>
                        <p class="text-[10px] text-slate-400">Total</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- WELLNESS/BIO-HACK TAB -->
        <div id="wellness" class="tab-pane">
            <div class="max-w-2xl mx-auto space-y-6">
                <h2 class="text-2xl font-black">üíÜ Centre Bio-Hack</h2>
                
                <!-- Rappels Programm√©s -->
                <div class="glass p-6 border-amber-500/30">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold flex items-center gap-2">
                            <i data-lucide="bell" class="w-5 h-5 text-amber-500"></i>
                            Rappels Automatiques
                        </h3>
                        <button onclick="toggleReminders()" id="reminder-toggle" class="px-4 py-2 bg-amber-500/20 text-amber-400 rounded-xl text-xs font-bold hover:bg-amber-500/30 touch-feedback">
                            Activer
                        </button>
                    </div>
                    <div class="space-y-3" id="reminders-list">
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">üíß</span>
                                <div>
                                    <p class="font-bold text-sm">Hydratation</p>
                                    <p class="text-[10px] text-slate-400">Toutes les 45 min</p>
                                </div>
                            </div>
                            <input type="checkbox" id="remind-water" class="w-5 h-5 rounded accent-amber-500" checked>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">üëÄ</span>
                                <div>
                                    <p class="font-bold text-sm">Pause Yeux</p>
                                    <p class="text-[10px] text-slate-400">Toutes les 20 min</p>
                                </div>
                            </div>
                            <input type="checkbox" id="remind-eyes" class="w-5 h-5 rounded accent-amber-500" checked>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">üßò</span>
                                <div>
                                    <p class="font-bold text-sm">√âtirement</p>
                                    <p class="text-[10px] text-slate-400">Toutes les heures</p>
                                </div>
                            </div>
                            <input type="checkbox" id="remind-stretch" class="w-5 h-5 rounded accent-amber-500">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">üìù</span>
                                <div>
                                    <p class="font-bold text-sm">Journal</p>
                                    <p class="text-[10px] text-slate-400">Chaque soir √† 21h</p>
                                </div>
                            </div>
                            <input type="checkbox" id="remind-journal" class="w-5 h-5 rounded accent-amber-500" checked>
                        </div>
                    </div>
                    <p id="reminder-status" class="text-[10px] text-slate-500 mt-3 text-center">Rappels d√©sactiv√©s</p>
                </div>
                
                <!-- Recommendations -->
                <div class="glass p-6">
                    <h3 class="font-bold mb-4">Recommandations IA</h3>
                    <div id="wellness-recommendations" class="space-y-4">
                        <p class="text-slate-400">Remplis ton journal pour des conseils personnalis√©s...</p>
                    </div>
                </div>
                
                <!-- Breathing Exercise -->
                <div class="glass p-8 text-center">
                    <h3 class="text-xl font-black mb-2">ü´Å Coh√©rence Cardiaque</h3>
                    <p class="text-sm text-slate-400 mb-6">5 secondes inspir, 5 secondes expir</p>
                    <div id="breathing-circle" class="w-32 h-32 mx-auto rounded-full bg-indigo-500/20 border-4 border-indigo-500 flex items-center justify-center mb-6 transition-all duration-[5000ms]">
                        <span id="breathing-text" class="font-bold">Pr√™t</span>
                    </div>
                    <button onclick="startBreathing()" id="breathing-btn" class="px-8 py-4 bg-indigo-600 rounded-2xl font-black uppercase text-sm hover:bg-indigo-500 transition touch-feedback">
                        Commencer
                    </button>
                </div>
                
                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="showTip('stretching')" class="glass p-6 text-center hover:bg-white/5 touch-feedback">
                        <span class="text-4xl">üßò</span>
                        <p class="font-bold mt-2">√âtirements</p>
                    </button>
                    <button onclick="showTip('hydration')" class="glass p-6 text-center hover:bg-white/5 touch-feedback">
                        <span class="text-4xl">üíß</span>
                        <p class="font-bold mt-2">Hydratation</p>
                    </button>
                    <button onclick="showTip('eyes')" class="glass p-6 text-center hover:bg-white/5 touch-feedback">
                        <span class="text-4xl">üëÄ</span>
                        <p class="font-bold mt-2">Repos yeux</p>
                    </button>
                    <button onclick="showTip('walk')" class="glass p-6 text-center hover:bg-white/5 touch-feedback">
                        <span class="text-4xl">üö∂</span>
                        <p class="font-bold mt-2">Micro-marche</p>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- SLOT MODAL -->
    <div id="modal" class="fixed inset-0 bg-black/95 backdrop-blur-2xl z-[100] hidden items-center justify-center p-4">
        <div class="glass max-w-sm w-full p-8 space-y-6 text-center">
            <h3 class="text-2xl font-black">üìù D√©tail du Cr√©neau</h3>
            <input type="text" id="course-name" placeholder="Nom (auto si vide)" 
                class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none focus:border-indigo-600 font-bold text-center">
            
            <!-- Types de cr√©neaux (avec nouveaux types) -->
            <div class="grid grid-cols-4 gap-2">
                <button id="btn-cours" onclick="selectType('cours')" class="type-btn p-3 text-[10px] font-black uppercase rounded-xl bg-indigo-600">
                    üìö Cours
                </button>
                <button id="btn-revisions" onclick="selectType('revisions')" class="type-btn p-3 text-[10px] font-black uppercase rounded-xl bg-amber-600">
                    ‚úèÔ∏è R√©vision
                </button>
                <button id="btn-repos" onclick="selectType('repos')" class="type-btn p-3 text-[10px] font-black uppercase rounded-xl bg-emerald-600">
                    üò¥ Repos
                </button>
                <button id="btn-sport" onclick="selectType('sport')" class="type-btn p-3 text-[10px] font-black uppercase rounded-xl bg-rose-600">
                    üèÉ Sport
                </button>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <button id="btn-social" onclick="selectType('social')" class="type-btn p-3 text-[10px] font-black uppercase rounded-xl bg-purple-600">
                    üë• Social
                </button>
                <button id="btn-admin" onclick="selectType('admin')" class="type-btn p-3 text-[10px] font-black uppercase rounded-xl bg-slate-600">
                    üìã Admin
                </button>
                <button id="btn-repas" onclick="selectType('repas')" class="type-btn p-3 text-[10px] font-black uppercase rounded-xl bg-orange-600">
                    üçΩÔ∏è Repas
                </button>
            </div>
            
            <div class="flex flex-col gap-2">
                <button onclick="confirmSlot()" class="w-full py-4 bg-white text-black font-black uppercase text-xs rounded-xl touch-feedback">Valider</button>
                <div class="flex gap-2">
                    <button onclick="deleteCurrentSlot()" class="flex-1 py-3 text-xs font-bold bg-red-500/10 text-red-500 rounded-xl touch-feedback">Supprimer</button>
                    <button onclick="closeModal()" class="flex-1 py-3 text-xs font-bold bg-white/5 rounded-xl touch-feedback">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DATA MODAL -->
    <div id="data-modal" class="fixed inset-0 bg-black/95 backdrop-blur-2xl z-[100] hidden items-center justify-center p-4 overflow-y-auto">
        <div class="glass max-w-md w-full p-8 space-y-6 my-8">
            <h3 class="text-2xl font-black text-center">üíæ Gestion des Donn√©es</h3>
            
            <!-- PRIVACY NOTICE -->
            <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">üîí</span>
                    <div>
                        <p class="font-bold text-emerald-400">Donn√©es 100% locales</p>
                        <p class="text-xs text-slate-400 mt-1">Vos donn√©es ne quittent jamais votre appareil. Aucun serveur, aucun tracking. Tout est stock√© dans votre navigateur (localStorage).</p>
                    </div>
                </div>
            </div>
            
            <!-- DATA INFO -->
            <div class="glass p-4 text-center">
                <p class="text-xs text-slate-400">Schema v<span id="data-schema-version">1</span> ‚Ä¢ Cr√©√© le <span id="data-created-at">-</span></p>
                <p class="text-xs text-slate-400">Derni√®re modification: <span id="data-last-modified">-</span></p>
            </div>
            
            <div class="space-y-4">
                <button onclick="exportJSON()" class="w-full glass p-4 flex items-center gap-4 hover:bg-white/10 touch-feedback">
                    <i data-lucide="download" class="w-6 h-6 text-indigo-500"></i>
                    <div class="text-left">
                        <p class="font-bold">Export JSON</p>
                        <p class="text-xs text-slate-400">Sauvegarde compl√®te</p>
                    </div>
                </button>
                <button onclick="exportPDF()" class="w-full glass p-4 flex items-center gap-4 hover:bg-white/10 touch-feedback">
                    <i data-lucide="file-text" class="w-6 h-6 text-pink-500"></i>
                    <div class="text-left">
                        <p class="font-bold">Export PDF</p>
                        <p class="text-xs text-slate-400">Bilan pour professionnel</p>
                    </div>
                </button>
                <button onclick="exportCalendar()" class="w-full glass p-4 flex items-center gap-4 hover:bg-white/10 touch-feedback">
                    <i data-lucide="calendar" class="w-6 h-6 text-amber-500"></i>
                    <div class="text-left">
                        <p class="font-bold">Export Google Calendar</p>
                        <p class="text-xs text-slate-400">Fichier .ics importable</p>
                    </div>
                </button>
                <label class="w-full glass p-4 flex items-center gap-4 hover:bg-white/10 cursor-pointer touch-feedback">
                    <i data-lucide="upload" class="w-6 h-6 text-emerald-500"></i>
                    <div class="text-left">
                        <p class="font-bold">Import JSON</p>
                        <p class="text-xs text-slate-400">Restaurer sauvegarde</p>
                    </div>
                    <input type="file" id="import-file" accept=".json" class="hidden" onchange="importJSON(event)">
                </label>
                
                <!-- DANGER ZONE -->
                <div class="pt-4 border-t border-white/10">
                    <p class="text-xs text-red-400 font-bold mb-3">‚ö†Ô∏è Zone dangereuse</p>
                    <button onclick="deleteAllData()" class="w-full glass p-4 flex items-center gap-4 hover:bg-red-500/20 border border-red-500/30 touch-feedback">
                        <i data-lucide="trash-2" class="w-6 h-6 text-red-500"></i>
                        <div class="text-left">
                            <p class="font-bold text-red-400">Supprimer toutes les donn√©es</p>
                            <p class="text-xs text-slate-400">Action irr√©versible</p>
                        </div>
                    </button>
                </div>
            </div>
            <button onclick="closeDataModal()" class="w-full py-3 bg-white/5 rounded-xl font-bold touch-feedback">Fermer</button>
        </div>
    </div>

    <!-- NOTES MODAL -->
    <div id="notes-modal" class="fixed inset-0 bg-black/95 backdrop-blur-2xl z-[100] hidden items-center justify-center p-4">
        <div class="glass max-w-lg w-full max-h-[80vh] flex flex-col">
            <div class="p-6 border-b border-white/10">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-black">üìù Mes Notes</h3>
                    <button onclick="closeNotesModal()" class="p-2 hover:bg-white/10 rounded-xl">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <!-- Search Bar -->
                <div class="relative mb-4">
                    <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="notes-search" placeholder="Rechercher..." 
                        class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-sm outline-none focus:border-indigo-500"
                        oninput="filterNotes()">
                </div>
                <!-- Category Filters -->
                <div class="flex gap-2 flex-wrap">
                    <button onclick="filterByCategory('all')" class="note-cat-btn active px-3 py-1 rounded-full text-[10px] font-bold bg-white/10" data-cat="all">Toutes</button>
                    <button onclick="filterByCategory('üìö')" class="note-cat-btn px-3 py-1 rounded-full text-[10px] font-bold bg-indigo-500/20 text-indigo-400" data-cat="üìö">üìö √âtudes</button>
                    <button onclick="filterByCategory('üí°')" class="note-cat-btn px-3 py-1 rounded-full text-[10px] font-bold bg-amber-500/20 text-amber-400" data-cat="üí°">üí° Id√©es</button>
                    <button onclick="filterByCategory('‚ù§Ô∏è')" class="note-cat-btn px-3 py-1 rounded-full text-[10px] font-bold bg-pink-500/20 text-pink-400" data-cat="‚ù§Ô∏è">‚ù§Ô∏è Perso</button>
                    <button onclick="filterByCategory('‚ö°')" class="note-cat-btn px-3 py-1 rounded-full text-[10px] font-bold bg-emerald-500/20 text-emerald-400" data-cat="‚ö°">‚ö° Urgent</button>
                </div>
            </div>
            <div id="notes-list" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- Notes will be inserted here -->
            </div>
            <div class="p-4 border-t border-white/10 flex gap-2">
                <button onclick="openAddNoteModal()" class="flex-1 py-3 bg-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-500 touch-feedback">
                    + Nouvelle Note
                </button>
                <button onclick="clearAllNotes()" class="px-4 py-3 bg-red-500/20 text-red-400 rounded-xl font-bold text-sm hover:bg-red-500/30 touch-feedback">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ADD NOTE MODAL -->
    <div id="add-note-modal" class="fixed inset-0 bg-black/95 backdrop-blur-2xl z-[110] hidden items-center justify-center p-4">
        <div class="glass max-w-md w-full p-6 space-y-4">
            <h3 class="text-xl font-black">‚úèÔ∏è Nouvelle Note</h3>
            <textarea id="new-note-text" rows="4" placeholder="√âcris ta note ici..."
                class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-sm outline-none focus:border-indigo-500 resize-none"></textarea>
            <div>
                <p class="text-[10px] font-bold text-slate-400 mb-2">CAT√âGORIE</p>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="selectNoteCategory('üìö')" class="new-note-cat px-4 py-2 rounded-xl text-sm font-bold bg-indigo-500/20 text-indigo-400 border-2 border-transparent hover:border-indigo-500" data-cat="üìö">üìö √âtudes</button>
                    <button onclick="selectNoteCategory('üí°')" class="new-note-cat px-4 py-2 rounded-xl text-sm font-bold bg-amber-500/20 text-amber-400 border-2 border-transparent hover:border-amber-500" data-cat="üí°">üí° Id√©es</button>
                    <button onclick="selectNoteCategory('‚ù§Ô∏è')" class="new-note-cat px-4 py-2 rounded-xl text-sm font-bold bg-pink-500/20 text-pink-400 border-2 border-transparent hover:border-pink-500" data-cat="‚ù§Ô∏è">‚ù§Ô∏è Perso</button>
                    <button onclick="selectNoteCategory('‚ö°')" class="new-note-cat px-4 py-2 rounded-xl text-sm font-bold bg-emerald-500/20 text-emerald-400 border-2 border-transparent hover:border-emerald-500" data-cat="‚ö°">‚ö° Urgent</button>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="saveNewNote()" class="flex-1 py-3 bg-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-500 touch-feedback">
                    üíæ Enregistrer
                </button>
                <button onclick="closeAddNoteModal()" class="px-6 py-3 bg-white/5 rounded-xl font-bold text-sm hover:bg-white/10 touch-feedback">
                    Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- FOCUS HISTORY MODAL -->
    <div id="focus-history-modal" class="fixed inset-0 bg-black/95 backdrop-blur-2xl z-[100] hidden items-center justify-center p-4">
        <div class="glass max-w-lg w-full max-h-[80vh] flex flex-col">
            <div class="p-6 border-b border-white/10">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-black">üéØ Historique Focus</h3>
                    <button onclick="closeFocusHistory()" class="p-2 hover:bg-white/10 rounded-xl">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <!-- Stats Summary -->
                <div class="grid grid-cols-3 gap-4 mt-4">
                    <div class="text-center">
                        <p class="text-2xl font-black text-indigo-500" id="focus-total-sessions">0</p>
                        <p class="text-[10px] text-slate-400">Sessions</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-black text-emerald-500" id="focus-total-hours">0h</p>
                        <p class="text-[10px] text-slate-400">Total</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-black text-amber-500" id="focus-avg-duration">0m</p>
                        <p class="text-[10px] text-slate-400">Moyenne</p>
                    </div>
                </div>
            </div>
            <div id="focus-history-list" class="flex-1 overflow-y-auto p-6 space-y-3">
                <!-- Sessions will be inserted here -->
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-24 md:bottom-8 left-1/2 -translate-x-1/2 glass px-6 py-4 rounded-2xl shadow-2xl z-[200] transform translate-y-32 opacity-0 transition-all flex items-center gap-3">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-500" id="toast-icon"></i>
        <p id="toast-text" class="font-bold text-sm"></p>
    </div>

    <!-- OFFLINE MODE DETECTION -->
    <div id="offline-banner" class="hidden fixed top-0 left-0 right-0 z-[300] bg-amber-500 text-black p-3 text-center text-sm font-bold">
        ‚ö° Mode hors-ligne actif ‚Äî Vos donn√©es sont sauvegard√©es localement
        <button onclick="this.parentElement.classList.add('hidden')" class="ml-4 px-2 py-1 bg-black/20 rounded">‚úï</button>
    </div>

    <!-- AUDIO for notifications - Using Web Audio API for reliable sound -->
    <script>
        // ==================== OFFLINE DETECTION ====================
        let isOnline = navigator.onLine;
        
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const banner = document.getElementById('offline-banner');
            if (banner) {
                if (!isOnline) {
                    banner.classList.remove('hidden');
                } else {
                    banner.classList.add('hidden');
                }
            }
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Check on load
        window.addEventListener('load', () => {
            updateOnlineStatus();
            
            // Check if critical libraries loaded
            const librariesOK = typeof Chart !== 'undefined' && typeof lucide !== 'undefined';
            if (!librariesOK && !isOnline) {
                console.warn('[App] Some libraries not loaded - limited offline mode');
            }
        });
        
        // ==================== SERVICE WORKER REGISTRATION ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('[App] Service Worker registered:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (confirm('Nouvelle version disponible ! Recharger ?')) {
                                        newWorker.postMessage('skipWaiting');
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => console.warn('[App] Service Worker registration failed:', err));
            });
        }
        
        // Sound generator using Web Audio API
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
            return audioCtx;
        }
        
        function playNotificationSound() {
            if (!db.settings.sound) return;
            
            try {
                const ctx = initAudio();
                if (ctx.state === 'suspended') ctx.resume();
                
                // Create oscillator for a pleasant notification sound
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.setValueAtTime(800, ctx.currentTime);
                oscillator.frequency.setValueAtTime(1000, ctx.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, ctx.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.5);
            } catch(e) {
                console.log('Audio error:', e);
            }
        }
        
        function playSuccessSound() {
            if (!db.settings.sound) return;
            
            try {
                const ctx = initAudio();
                if (ctx.state === 'suspended') ctx.resume();
                
                // Success melody
                const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
                
                notes.forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0.2, ctx.currentTime + i * 0.15);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.15 + 0.3);
                    
                    osc.start(ctx.currentTime + i * 0.15);
                    osc.stop(ctx.currentTime + i * 0.15 + 0.3);
                });
            } catch(e) {
                console.log('Audio error:', e);
            }
        }
        
        function playAlertSound() {
            if (!db.settings.sound) return;
            
            try {
                const ctx = initAudio();
                if (ctx.state === 'suspended') ctx.resume();
                
                // Alert beeps
                for (let i = 0; i < 3; i++) {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    
                    osc.frequency.value = 880;
                    gain.gain.setValueAtTime(0.3, ctx.currentTime + i * 0.2);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.2 + 0.1);
                    
                    osc.start(ctx.currentTime + i * 0.2);
                    osc.stop(ctx.currentTime + i * 0.2 + 0.1);
                }
            } catch(e) {
                console.log('Audio error:', e);
            }
        }
    </script>

    <script>
        // ==================== DATABASE ====================
        // ==================== CONFIG (Constantes centralis√©es) ====================
        const CONFIG = {
            VERSION: 2,
            STORAGE_KEY: 'sf_ultimate_pro_v2',
            
            // Planning
            HOURS: { min: 6, max: 22 },
            DAYS: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
            SLOT_DURATION: 60, // minutes (30 ou 60)
            
            // Types de cr√©neaux avec couleurs
            SLOT_TYPES: {
                cours: { label: 'Cours', color: 'indigo', gradient: 'from-indigo-600 to-indigo-800', icon: 'üìö' },
                revisions: { label: 'R√©vision', color: 'amber', gradient: 'from-amber-500 to-amber-700', icon: '‚úèÔ∏è' },
                repos: { label: 'Repos', color: 'emerald', gradient: 'from-emerald-500 to-emerald-700', icon: 'üò¥' },
                sport: { label: 'Sport', color: 'rose', gradient: 'from-rose-500 to-rose-700', icon: 'üèÉ' },
                social: { label: 'Social', color: 'purple', gradient: 'from-purple-500 to-purple-700', icon: 'üë•' },
                admin: { label: 'Admin', color: 'slate', gradient: 'from-slate-500 to-slate-700', icon: 'üìã' },
                repas: { label: 'Repas', color: 'orange', gradient: 'from-orange-500 to-orange-700', icon: 'üçΩÔ∏è' }
            },
            
            // Safe Mode
            SAFE_MODE: {
                THRESHOLDS: {
                    critical: { score: 80, sleepMin: 5, stressMin: 8, loadMax: 35 },
                    alert: { score: 60, sleepMin: 6, stressMin: 7, loadMax: 30 },
                    watch: { score: 40, sleepMin: 6.5, stressMin: 6, loadMax: 25 }
                },
                WEIGHTS: { sleep: 0.3, stress: 0.3, load: 0.2, streak: 0.1, restRatio: 0.1 }
            },
            
            // Focus / Pomodoro
            POMODORO: {
                WORK: 25,
                SHORT_BREAK: 5,
                LONG_BREAK: 15,
                SESSIONS_BEFORE_LONG: 4
            },
            
            // Gamification
            GAMIFICATION: {
                WISDOM_PER_LEVEL: 100,
                STREAK_BONUS_THRESHOLD: 7,
                STREAK_MULTIPLIER: 2
            },
            
            // Rappels (minutes)
            REMINDERS: {
                water: 45,
                eyes: 20,
                stretch: 60,
                journalHour: 21
            },
            
            // Quiet hours
            QUIET_HOURS: { start: 23, end: 7 }
        };
        
        // ==================== STATE MANAGER ====================
        const StateManager = {
            _state: null,
            _listeners: [],
            _charts: { main: null, radar: null, trend: null },
            
            // Initialiser l'√©tat
            init() {
                this._state = this._loadFromStorage();
                this._migrateIfNeeded();
                return this._state;
            },
            
            // Charger depuis localStorage avec fallback
            _loadFromStorage() {
                try {
                    // Essayer nouvelle cl√© d'abord
                    let data = localStorage.getItem(CONFIG.STORAGE_KEY);
                    if (data) return JSON.parse(data);
                    
                    // Migration depuis ancienne cl√©
                    data = localStorage.getItem('sf_ultimate_pro');
                    if (data) {
                        const parsed = JSON.parse(data);
                        parsed.version = 1; // Marquer pour migration
                        return parsed;
                    }
                } catch (e) {
                    console.error('Erreur chargement localStorage:', e);
                    this._backup();
                }
                return this._getDefaultState();
            },
            
            // √âtat par d√©faut avec schemaVersion
            _getDefaultState() {
                return {
                    // === META (ne pas toucher) ===
                    schemaVersion: 1,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    appVersion: CONFIG.VERSION,
                    
                    // === DONN√âES UTILISATEUR ===
                    timetable: {},
                    logs: [],
                    gamification: { level: 1, wisdom: 0, streak: 0, lastEntry: null },
                    focusSessions: [],
                    goals: [],
                    notes: [],
                    templates: {},
                    settings: { 
                        sound: true, 
                        theme: 'dark', 
                        notifications: false,
                        quietHours: true,
                        slotDuration: 60
                    },
                    safeMode: { active: false, score: 0, dismissedAt: null, reasons: [] }
                };
            },
            
            // Migration de sch√©ma (IMPORTANT: garder r√©tro-compatible)
            _migrateIfNeeded() {
                const currentSchema = this._state.schemaVersion || 0;
                
                // Schema 0 ‚Üí 1 : Ajouter meta + structure
                if (currentSchema < 1) {
                    console.log('[Migration] Schema 0 ‚Üí 1');
                    
                    // Ajouter meta fields
                    if (!this._state.schemaVersion) this._state.schemaVersion = 1;
                    if (!this._state.createdAt) this._state.createdAt = new Date().toISOString();
                    if (!this._state.lastModified) this._state.lastModified = new Date().toISOString();
                    if (!this._state.appVersion) this._state.appVersion = CONFIG.VERSION;
                    
                    // Ajouter champs manquants
                    if (!this._state.templates) this._state.templates = {};
                    if (!this._state.safeMode) this._state.safeMode = { active: false, score: 0, dismissedAt: null, reasons: [] };
                    if (!this._state.settings) this._state.settings = {};
                    if (this._state.settings.quietHours === undefined) this._state.settings.quietHours = true;
                    if (!this._state.settings.slotDuration) this._state.settings.slotDuration = 60;
                    
                    // Migrer notes
                    if (this._state.notes) {
                        this._state.notes = this._state.notes.map(n => ({
                            ...n,
                            id: n.id || this._generateId(),
                            category: n.category || 'üìö'
                        }));
                    }
                    
                    // Migrer timetable
                    if (this._state.timetable) {
                        const newTimetable = {};
                        Object.entries(this._state.timetable).forEach(([key, slot]) => {
                            newTimetable[key] = {
                                ...slot,
                                id: slot.id || this._generateId(),
                                createdAt: slot.createdAt || new Date().toISOString()
                            };
                        });
                        this._state.timetable = newTimetable;
                    }
                    
                    // Supprimer ancien champ version
                    delete this._state.version;
                }
                
                // Future migrations ici:
                // if (currentSchema < 2) { ... }
                
                // Marquer schema final
                this._state.schemaVersion = 1;
                this._state.appVersion = CONFIG.VERSION;
                this.save();
            },
            
            // G√©n√©rer ID unique
            _generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },
            
            // Backup en cas d'erreur
            _backup() {
                const backup = localStorage.getItem(CONFIG.STORAGE_KEY);
                if (backup) {
                    localStorage.setItem(CONFIG.STORAGE_KEY + '_backup_' + Date.now(), backup);
                }
            },
            
            // Getter
            get(path) {
                if (!path) return this._state;
                return path.split('.').reduce((obj, key) => obj?.[key], this._state);
            },
            
            // Setter avec notification
            set(path, value) {
                const keys = path.split('.');
                const lastKey = keys.pop();
                const target = keys.reduce((obj, key) => obj[key] = obj[key] || {}, this._state);
                target[lastKey] = value;
                this.save();
                this._notify(path);
            },
            
            // Mise √† jour partielle
            update(partial) {
                Object.assign(this._state, partial);
                this.save();
                this._notify('*');
            },
            
            // Sauvegarder avec timestamp
            save() {
                try {
                    this._state.lastModified = new Date().toISOString();
                    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(this._state));
                } catch (e) {
                    console.error('Erreur sauvegarde:', e);
                    showToast('‚ö†Ô∏è Erreur de sauvegarde');
                }
            },
            
            // Listeners
            subscribe(callback) {
                this._listeners.push(callback);
                return () => this._listeners = this._listeners.filter(l => l !== callback);
            },
            
            _notify(path) {
                this._listeners.forEach(l => l(path, this._state));
            },
            
            // Charts
            setChart(name, instance) { this._charts[name] = instance; },
            getChart(name) { return this._charts[name]; },
            destroyChart(name) {
                if (this._charts[name]) {
                    this._charts[name].destroy();
                    this._charts[name] = null;
                }
            }
        };
        
        // ==================== HELPERS ====================
        const Helpers = {
            // G√©n√©rer ID
            genId: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            
            // Date helpers
            today: () => new Date().toISOString().slice(0, 10),
            dayName: (date = new Date()) => CONFIG.DAYS[date.getDay() === 0 ? 6 : date.getDay() - 1],
            
            // Escape HTML
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            // Calculer charge hebdo
            getWeeklyLoad() {
                const timetable = StateManager.get('timetable');
                return Object.values(timetable).filter(s => s.type !== 'repos').length;
            },
            
            // Calculer ratio repos
            getRestRatio() {
                const timetable = StateManager.get('timetable');
                const total = Object.keys(timetable).length;
                if (total === 0) return 0;
                const rest = Object.values(timetable).filter(s => s.type === 'repos').length;
                return rest / total;
            },
            
            // Stats des logs r√©cents
            getRecentStats(days = 7) {
                const logs = StateManager.get('logs');
                const recent = logs.slice(-days);
                if (recent.length === 0) return { avgStress: 5, avgSleep: 7, count: 0 };
                
                return {
                    avgStress: recent.reduce((a, b) => a + b.stress, 0) / recent.length,
                    avgSleep: recent.reduce((a, b) => a + b.sleep, 0) / recent.length,
                    count: recent.length
                };
            },
            
            // Quiet hours check
            isQuietHours() {
                if (!StateManager.get('settings.quietHours')) return false;
                const hour = new Date().getHours();
                const { start, end } = CONFIG.QUIET_HOURS;
                return hour >= start || hour < end;
            }
        };
        
        // Alias pour compatibilit√©
        let db = StateManager.init();
        
        // Variables UI
        let currentSlotId = null;
        let currentType = 'cours';
        let pomodoroTimer = null;
        let pomodoroSeconds = CONFIG.POMODORO.WORK * 60;
        let pomodoroInitial = CONFIG.POMODORO.WORK * 60;
        let pomodoroActive = false;
        let pomodoroSessionCount = 0;
        let breathingInterval = null;
        let selectedMood = 'üòä';
        let draggedSlot = null;

        // ==================== INIT ====================
        window.onload = () => { 
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            // Apply saved theme
            if (db.settings.theme === 'light') {
                document.body.classList.add('light-mode');
            }
            
            // Update theme icon based on saved theme
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.setAttribute('data-lucide', db.settings.theme === 'light' ? 'moon' : 'sun');
                lucide.createIcons();
            }
            
            // Update sound icon
            updateSoundIcon();
            
            renderGrid(); 
            refreshAll(); 
            checkSafeMode(); 
            updateGamification();
            renderGoals();
            updateAnalytics();
            updateSessionDots();
            updateTodaySessions();
            
            // Stress slider listener
            document.getElementById('in-stress').addEventListener('input', (e) => {
                document.getElementById('stress-display').textContent = e.target.value;
                checkJournalSuggestions();
            });
            
            // Sleep input listener
            document.getElementById('in-sleep').addEventListener('input', () => {
                checkJournalSuggestions();
            });
            
            // Check for notifications permission
            if (db.settings.notifications && Notification.permission === 'granted') {
                // Already granted
            }
            
        };
        
        // ==================== RACCOURCIS CLAVIER (outside onload for reliability) ====================
        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('keydown', (e) => {
                // Ignorer si on est dans un input/textarea
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                // Ignorer si un modal est ouvert (sauf Escape)
                const modalOpen = document.getElementById('modal')?.style.display === 'flex' ||
                                  document.getElementById('data-modal')?.style.display === 'flex' ||
                                  document.getElementById('notes-modal')?.style.display === 'flex' ||
                                  document.getElementById('add-note-modal')?.style.display === 'flex';
                
                // Escape - Fermer les modals
                if (e.key === 'Escape') {
                    closeModal();
                    closeDataModal();
                    closeNotesModal();
                    closeAddNoteModal();
                    closeFocusHistory();
                    return;
                }
                
                // Si modal ouvert, ignorer autres raccourcis
                if (modalOpen) return;
                
                // N - Nouvelle note (Ctrl+N ou juste N)
                if ((e.key === 'n' || e.key === 'N') && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    openAddNoteModal();
                    showToast('üìù Raccourci: Nouvelle note');
                }
                
                // F - Focus mode
                if ((e.key === 'f' || e.key === 'F') && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    switchTab('focus');
                    showToast('üéØ Raccourci: Focus');
                }
                
                // J - Journal
                if ((e.key === 'j' || e.key === 'J') && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    switchTab('log');
                    showToast('‚ù§Ô∏è Raccourci: Journal');
                }
                
                // P - Planning
                if ((e.key === 'p' || e.key === 'P') && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    switchTab('sched');
                    showToast('üìÖ Raccourci: Planning');
                }
                
                // A - Analytics
                if ((e.key === 'a' || e.key === 'A') && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    switchTab('analytics');
                    showToast('üìä Raccourci: Analytics');
                }
                
                // Space - Start/Pause Pomodoro (only in focus tab)
                if (e.key === ' ' && document.getElementById('focus')?.classList.contains('active')) {
                    e.preventDefault();
                    if (pomodoroTimer) pausePomodoro();
                    else startPomodoro();
                }
                
                // T - Toggle theme
                if ((e.key === 't' || e.key === 'T') && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    toggleTheme();
                }
                
                // S - Toggle ambient sound (in focus tab)
                if ((e.key === 's' || e.key === 'S') && !e.ctrlKey && !e.metaKey && document.getElementById('focus')?.classList.contains('active')) {
                    e.preventDefault();
                    toggleAmbientSound();
                }
            });
        });

        // ==================== THEME ====================
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            db.settings.theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            save();
            
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.setAttribute('data-lucide', db.settings.theme === 'light' ? 'moon' : 'sun');
                lucide.createIcons();
            }
            
            playNotificationSound();
            showToast(db.settings.theme === 'light' ? '‚òÄÔ∏è Mode clair' : 'üåô Mode sombre');
        }

        // ==================== SOUND ====================
        function toggleSound() {
            db.settings.sound = !db.settings.sound;
            save();
            updateSoundIcon();
            showToast(db.settings.sound ? 'üîî Sons activ√©s' : 'üîï Sons d√©sactiv√©s');
        }
        
        function updateSoundIcon() {
            const icon = document.getElementById('sound-icon');
            if (icon) {
                icon.setAttribute('data-lucide', db.settings.sound ? 'volume-2' : 'volume-x');
                lucide.createIcons();
            }
        }
        
        function testSound() {
            const wasEnabled = db.settings.sound;
            db.settings.sound = true; // Temporarily enable
            playSuccessSound();
            db.settings.sound = wasEnabled; // Restore
            showToast('üîä Test son!');
        }
        

        // ==================== NOTIFICATIONS ====================
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showToast('‚ùå Notifications non support√©es');
                return;
            }
            
            // Check if already granted
            if (Notification.permission === 'granted') {
                db.settings.notifications = true;
                save();
                showToast('‚úÖ Notifications d√©j√† activ√©es');
                return;
            }
            
            // Check if already denied (don't spam)
            if (Notification.permission === 'denied') {
                showToast('‚ö†Ô∏è Notifications bloqu√©es dans le navigateur');
                return;
            }
            
            // Check if we already asked (stored in db)
            if (db.settings.notificationAsked && Notification.permission === 'default') {
                showToast('üí° Activez les notifications dans les param√®tres du navigateur');
                return;
            }
            
            // First time asking
            db.settings.notificationAsked = true;
            save();
            
            Notification.requestPermission().then(perm => {
                if (perm === 'granted') {
                    db.settings.notifications = true;
                    save();
                    showToast('‚úÖ Notifications activ√©es');
                    new Notification('StudentFlow', { body: 'Notifications activ√©es!' });
                } else {
                    showToast('‚ùå Notifications refus√©es');
                }
            });
        }
        
        function sendNotification(title, body) {
            if (!db.settings.notifications || Notification.permission !== 'granted') return;
            new Notification(title, { body, icon: 'üéØ' });
        }

        // ==================== GAMIFICATION ====================
        function updateGamification() {
            const g = db.gamification;
            const levelProgress = (g.wisdom % 100);
            
            document.getElementById('user-level').textContent = g.level;
            document.getElementById('wisdom-points').textContent = g.wisdom;
            document.getElementById('wisdom-display').textContent = g.wisdom;
            document.getElementById('streak-count').textContent = g.streak + 'j';
            
            const progressBar = document.getElementById('level-progress');
            if (progressBar) progressBar.style.width = levelProgress + '%';
            
            const streakBonus = document.getElementById('streak-bonus');
            if (streakBonus) {
                streakBonus.classList.toggle('hidden', g.streak < 7);
            }
        }

        function addWisdom(points, reason) {
            const multiplier = db.gamification.streak >= 7 ? 2 : 1;
            const finalPoints = points * multiplier;
            
            db.gamification.wisdom += finalPoints;
            const newLevel = Math.floor(db.gamification.wisdom / 100) + 1;
            
                if (newLevel > db.gamification.level) {
                    db.gamification.level = newLevel;
                    showToast(`üéâ NIVEAU ${newLevel} !`, true);
                    triggerConfetti();
                } else {
                    showToast(`‚ú® +${finalPoints} Sagesse: ${reason}`, true);
                }
            
            save(); 
            updateGamification();
        }

        function updateStreak() {
            const today = new Date().toISOString().slice(0, 10);
            const lastEntry = db.gamification.lastEntry;
            
            if (!lastEntry) {
                db.gamification.streak = 1;
            } else {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().slice(0, 10);
                
                if (lastEntry === yesterdayStr) {
                    db.gamification.streak++;
                    if (db.gamification.streak % 7 === 0) {
                        addWisdom(50, `Streak ${db.gamification.streak}j!`);
                        triggerConfetti();
                    }
                } else if (lastEntry !== today) {
                    db.gamification.streak = 1;
                }
            }
            
            db.gamification.lastEntry = today;
        }

        function triggerConfetti() {
            if (typeof confetti !== 'undefined') {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }

        // ==================== SAFE MODE ====================
        // ==================== SAFE MODE INTELLIGENT ====================
        function calculateBurnoutScore() {
            const stats = Helpers.getRecentStats(5);
            const load = Helpers.getWeeklyLoad();
            const restRatio = Helpers.getRestRatio();
            const streak = db.gamification.streak;
            const weights = CONFIG.SAFE_MODE.WEIGHTS;
            
            // Scores individuels (0-100, plus haut = plus de risque)
            const sleepScore = Math.max(0, Math.min(100, (8 - stats.avgSleep) * 20)); // 8h=0, 3h=100
            const stressScore = stats.avgStress * 10; // 0=0, 10=100
            const loadScore = Math.min(100, (load / 40) * 100); // 40h=100
            const streakPenalty = streak < 3 ? 20 : 0; // Pas de r√©gularit√©
            const restScore = Math.max(0, (0.2 - restRatio) * 200); // <20% repos = risque
            
            // Score pond√©r√©
            const score = Math.round(
                sleepScore * weights.sleep +
                stressScore * weights.stress +
                loadScore * weights.load +
                streakPenalty * weights.streak +
                restScore * weights.restRatio
            );
            
            // Raisons explicables
            const reasons = [];
            if (stats.avgSleep < 6) reasons.push(`üò¥ Sommeil moy: ${stats.avgSleep.toFixed(1)}h (<6h)`);
            if (stats.avgStress > 7) reasons.push(`üò∞ Stress moy: ${stats.avgStress.toFixed(1)}/10 (>7)`);
            if (load > 30) reasons.push(`üìö Charge: ${load}h/sem (>30h)`);
            if (restRatio < 0.15) reasons.push(`‚ö†Ô∏è Ratio repos: ${Math.round(restRatio*100)}% (<15%)`);
            if (streak < 3) reasons.push(`üìÖ Streak: ${streak}j (irr√©gulier)`);
            
            return { score: Math.min(100, score), reasons };
        }
        
        function checkSafeMode() {
            const { score, reasons } = calculateBurnoutScore();
            const thresholds = CONFIG.SAFE_MODE.THRESHOLDS;
            
            // Stocker le score
            db.safeMode = db.safeMode || {};
            db.safeMode.score = score;
            db.safeMode.reasons = reasons;
            
            // V√©rifier si d√©j√† dismiss√© r√©cemment (24h)
            if (db.safeMode.dismissedAt) {
                const dismissedTime = new Date(db.safeMode.dismissedAt).getTime();
                if (Date.now() - dismissedTime < 24 * 60 * 60 * 1000) {
                    return; // Pas de r√©activation avant 24h
                }
            }
            
            // D√©terminer le niveau
            let level = 'ok';
            if (score >= thresholds.critical.score) level = 'critical';
            else if (score >= thresholds.alert.score) level = 'alert';
            else if (score >= thresholds.watch.score) level = 'watch';
            
            db.safeMode.level = level;
            save();
            
            // Activer si n√©cessaire
            if (level === 'critical' || level === 'alert') {
                activateSafeMode(level, score, reasons);
            } else {
                deactivateSafeMode();
            }
            
            // Mettre √† jour l'affichage
            updateSafeModeUI(score, level);
        }

        function activateSafeMode(level, score, reasons) {
            db.safeMode.active = true;
            save();
            
            document.body.classList.add('safe-mode');
            const banner = document.getElementById('safe-mode-banner');
            banner.classList.remove('hidden');
            
            // Personnaliser selon le niveau
            const titleEl = banner.querySelector('.font-black');
            const reasonsEl = document.getElementById('safe-mode-reasons');
            
            if (level === 'critical') {
                titleEl.textContent = 'üö® SAFE MODE CRITIQUE';
                titleEl.className = 'font-black text-sm text-red-500';
            } else {
                titleEl.textContent = '‚ö†Ô∏è SAFE MODE ALERTE';
                titleEl.className = 'font-black text-sm text-amber-500';
            }
            
            // Afficher les raisons
            if (reasonsEl) {
                reasonsEl.innerHTML = reasons.map(r => `<span class="text-[10px] text-slate-400">${r}</span>`).join(' ‚Ä¢ ');
            }
            
            // Score
            const scoreEl = document.getElementById('burnout-score');
            if (scoreEl) {
                scoreEl.textContent = score;
                scoreEl.className = `text-2xl font-black ${level === 'critical' ? 'text-red-500' : 'text-amber-500'}`;
            }
            
            lucide.createIcons();
            
            if (!Helpers.isQuietHours()) {
                playAlertSound();
                sendNotification('üö® SAFE MODE', `Score burn-out: ${score}/100`);
            }
        }
        
        function deactivateSafeMode() {
            db.safeMode.active = false;
            save();
            document.body.classList.remove('safe-mode');
            document.getElementById('safe-mode-banner').classList.add('hidden');
        }
        
        function updateSafeModeUI(score, level) {
            const scoreDisplay = document.getElementById('burnout-score-display');
            if (scoreDisplay) {
                scoreDisplay.textContent = score;
                const colors = { ok: 'text-emerald-500', watch: 'text-amber-400', alert: 'text-orange-500', critical: 'text-red-500' };
                scoreDisplay.className = `text-4xl font-black ${colors[level]}`;
            }
        }

        function convertRevisionsToRest(percentage = 100) {
            const revisions = Object.entries(db.timetable).filter(([k, v]) => v.type === 'revisions');
            const toConvert = Math.ceil(revisions.length * (percentage / 100));
            
            let count = 0;
            revisions.slice(0, toConvert).forEach(([key, slot]) => {
                db.timetable[key] = { 
                    ...slot, 
                    name: 'REPOS', 
                    type: 'repos',
                    convertedAt: new Date().toISOString()
                };
                count++;
            });
            
            if (count > 0) {
                save(); renderGrid(); refreshAll();
                playSuccessSound();
                showToast(`üõ°Ô∏è ${count} cr√©neaux convertis en repos`);
            }
            dismissSafeMode();
        }
        
        function reduceLoad(percentage = 20) {
            const revisions = Object.entries(db.timetable).filter(([k, v]) => v.type === 'revisions');
            const toRemove = Math.ceil(revisions.length * (percentage / 100));
            
            revisions.slice(0, toRemove).forEach(([key]) => {
                delete db.timetable[key];
            });
            
            save(); renderGrid(); refreshAll();
            showToast(`üìâ Charge r√©duite de ${percentage}%`);
        }

        function dismissSafeMode() {
            db.safeMode.dismissedAt = new Date().toISOString();
            db.safeMode.active = false;
            save();
            document.body.classList.remove('safe-mode');
            document.getElementById('safe-mode-banner').classList.add('hidden');
            showToast('Safe mode d√©sactiv√© pour 24h');
        }

        // ==================== PLANNING GRID ====================
        function renderGrid() {
            const root = document.getElementById('grid-root');
            if (!root) return;
            
            root.innerHTML = "";
            for (let h = 8; h <= 19; h++) {
                root.innerHTML += `<div class="flex items-center justify-center font-bold text-[9px] text-slate-600">${h}h</div>`;
                for (let d = 1; d <= 7; d++) {
                    const id = `${d}-${h}`;
                    const item = db.timetable[id];
                    const cls = item ? `type-${item.type}` : 'slot-empty';
                    const isWeekend = d >= 6;
                    root.innerHTML += `<div onclick="openModal('${id}')" class="slot ${cls} ${isWeekend ? 'opacity-80' : ''}">${item ? item.name : '+'}</div>`;
                }
            }
        }

        function openModal(id) {
            currentSlotId = id;
            const ex = db.timetable[id];
            document.getElementById('course-name').value = ex ? ex.name : "";
            selectType(ex ? ex.type : 'cours');
            document.getElementById('modal').style.display = 'flex';
            lucide.createIcons();
        }

        function selectType(type) {
            currentType = type;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
            const btn = document.getElementById('btn-' + type);
            if (btn) btn.classList.add('selected');
        }

        function closeModal() { 
            document.getElementById('modal').style.display = 'none'; 
        }

        function confirmSlot() {
            let name = document.getElementById('course-name').value.trim();
            if (!name) {
                const typeConfig = CONFIG.SLOT_TYPES[currentType];
                name = typeConfig ? typeConfig.label.toUpperCase() : currentType.toUpperCase();
            }

            const isNew = !db.timetable[currentSlotId];
            db.timetable[currentSlotId] = { name, type: currentType };
            
            if (isNew) addWisdom(5, 'Cr√©neau planifi√©');
            
            save(); renderGrid(); closeModal(); refreshAll();
        }

        function deleteCurrentSlot() {
            if (db.timetable[currentSlotId]) {
                delete db.timetable[currentSlotId];
                save(); renderGrid(); closeModal(); refreshAll();
                showToast('üóëÔ∏è Cr√©neau supprim√©');
            }
        }

        function clearPlanning() {
            if (!confirm('Vider tout le planning ?')) return;
            db.timetable = {};
            save(); renderGrid(); refreshAll();
            showToast('üìÖ Planning vid√©');
        }

        // ==================== PREDICTIONS ====================
        function predictStress() {
            const load = Object.values(db.timetable).filter(i => i.type !== 'repos').length;
            const lastLog = db.logs[db.logs.length - 1];
            const avgStress = db.logs.length > 0 ? db.logs.reduce((a,b) => a + b.stress, 0) / db.logs.length : 5;
            
            let msg = 'üìä Remplis ton planning pour une pr√©diction pr√©cise.';
            
            if (load > 0) {
                if (load < 10) {
                    msg = `‚òÄÔ∏è Semaine l√©g√®re (${load}h). Parfait pour des projets perso!`;
                } else if (load < 20) {
                    msg = `‚õÖ Charge mod√©r√©e (${load}h). Maintiens tes routines de sommeil.`;
                } else if (load < 30) {
                    msg = `üå§Ô∏è Semaine charg√©e (${load}h). Pr√©vois des pauses r√©guli√®res.`;
                } else {
                    msg = `‚ö†Ô∏è ALERTE: ${load}h planifi√©es! Risque de surcharge. Lib√®re des cr√©neaux.`;
                }
                
                if (lastLog && lastLog.stress > 7) {
                    msg += ' üî¥ Ton stress est d√©j√† √©lev√©, priorise le repos.';
                }
            }
            
            document.getElementById('prediction-text').textContent = msg;
        }

        // ==================== ANALYTICS ====================
        function updateAnalytics() {
            updateHeatmap();
            updateRadarChart();
            updateTrendChart();
            updateAnalyticsStats();
            updateMonthlyStats();
            updateMoodCalendar();
            updateWeekComparison();
        }

        function updateHeatmap() {
            const heatmap = document.getElementById('heatmap');
            if (!heatmap) return;
            
            const days = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
            let html = days.map(d => `<div class="text-center text-[10px] text-slate-500 font-bold">${d}</div>`).join('');
            
            for (let h = 8; h <= 18; h++) {
                for (let d = 1; d <= 7; d++) {
                    const id = `${d}-${h}`;
                    const hasSlot = db.timetable[id];
                    const heatLevel = hasSlot ? (hasSlot.type === 'cours' ? 4 : hasSlot.type === 'revisions' ? 3 : 1) : 0;
                    html += `<div class="heatmap-cell h-4 rounded heat-${heatLevel}" title="${h}h"></div>`;
                }
            }
            
            heatmap.innerHTML = html;
        }

        function updateRadarChart() {
            const ctx = document.getElementById('radar-chart');
            if (!ctx || db.logs.length === 0) return;
            
            if (radarChart) radarChart.destroy();
            
            const avgStress = db.logs.reduce((a,b) => a + b.stress, 0) / db.logs.length;
            const avgSleep = db.logs.reduce((a,b) => a + b.sleep, 0) / db.logs.length;
            const focusScore = Math.min(10, db.focusSessions.length);
            const planningScore = Math.min(10, Object.keys(db.timetable).length / 3);
            const streakScore = Math.min(10, db.gamification.streak);
            
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['√ânergie', 'Focus', 'Planning', 'R√©gularit√©', 'Repos'],
                    datasets: [{
                        data: [10 - avgStress, focusScore, planningScore, streakScore, avgSleep],
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: '#6366f1',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { r: { beginAtZero: true, max: 10, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.1)' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateTrendChart() {
            const ctx = document.getElementById('trend-chart');
            if (!ctx || db.logs.length < 2) return;
            
            if (trendChart) trendChart.destroy();
            
            const last30 = db.logs.slice(-30);
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30.map((l, i) => i + 1),
                    datasets: [
                        { label: 'Stress', data: last30.map(l => l.stress), borderColor: '#f43f5e', tension: 0.4, borderWidth: 2 },
                        { label: 'Sommeil', data: last30.map(l => l.sleep), borderColor: '#6366f1', tension: 0.4, borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateAnalyticsStats() {
            if (db.logs.length === 0) return;
            
            // Best day
            const dayStats = {};
            db.logs.forEach(l => {
                if (!dayStats[l.day]) dayStats[l.day] = { stress: 0, count: 0 };
                dayStats[l.day].stress += l.stress;
                dayStats[l.day].count++;
            });
            
            let bestDay = '--';
            let minAvg = Infinity;
            Object.entries(dayStats).forEach(([day, data]) => {
                const avg = data.stress / data.count;
                if (avg < minAvg) {
                    minAvg = avg;
                    bestDay = day;
                }
            });
            document.getElementById('stat-best-day').textContent = bestDay;
            
            // Focus sessions
            document.getElementById('stat-total-focus').textContent = db.focusSessions.length;
            
            // Avg sleep
            const avgSleep = (db.logs.reduce((a,b) => a + b.sleep, 0) / db.logs.length).toFixed(1);
            document.getElementById('stat-avg-sleep').textContent = avgSleep + 'h';
            
            // Stress trend
            if (db.logs.length >= 2) {
                const recent = db.logs.slice(-3);
                const older = db.logs.slice(-6, -3);
                if (older.length > 0) {
                    const recentAvg = recent.reduce((a,b) => a + b.stress, 0) / recent.length;
                    const olderAvg = older.reduce((a,b) => a + b.stress, 0) / older.length;
                    const trend = recentAvg < olderAvg ? 'üìâ' : recentAvg > olderAvg ? 'üìà' : '‚û°Ô∏è';
                    document.getElementById('stat-stress-trend').textContent = trend;
                }
            }
        }
        
        function updateMonthlyStats() {
            const now = new Date();
            const monthName = now.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            document.getElementById('current-month').textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
            
            // Filter this month's data
            const thisMonth = db.logs.filter(l => {
                const d = new Date(l.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            
            const monthFocusSessions = db.focusSessions.filter(s => {
                const d = new Date(s.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            
            // Stats
            document.getElementById('month-entries').textContent = thisMonth.length;
            
            const focusMinutes = monthFocusSessions.reduce((sum, s) => sum + (s.duration || 25), 0);
            document.getElementById('month-focus').textContent = Math.floor(focusMinutes / 60) + 'h';
            
            if (thisMonth.length > 0) {
                const avgStress = (thisMonth.reduce((a, b) => a + b.stress, 0) / thisMonth.length).toFixed(1);
                const avgSleep = (thisMonth.reduce((a, b) => a + b.sleep, 0) / thisMonth.length).toFixed(1);
                
                document.getElementById('month-avg-stress').textContent = avgStress;
                document.getElementById('month-avg-sleep').textContent = avgSleep + 'h';
                
                // Health Score (0-100)
                const stressScore = Math.max(0, (10 - parseFloat(avgStress)) * 10); // 0-10 stress -> 100-0 score
                const sleepScore = Math.min(100, (parseFloat(avgSleep) / 8) * 100); // 8h = 100%
                const streakScore = Math.min(100, db.gamification.streak * 10); // 10 days = 100%
                const focusScore = Math.min(100, monthFocusSessions.length * 5); // 20 sessions = 100%
                
                const healthScore = Math.round((stressScore + sleepScore + streakScore + focusScore) / 4);
                document.getElementById('month-score').textContent = healthScore;
                document.getElementById('health-score-percent').textContent = healthScore + '%';
                document.getElementById('health-score-bar').style.width = healthScore + '%';
            }
        }
        
        function updateMoodCalendar() {
            const calendar = document.getElementById('mood-calendar');
            if (!calendar) return;
            
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            
            // Build mood map
            const moodMap = {};
            db.logs.forEach(l => {
                const d = new Date(l.date);
                if (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
                    moodMap[d.getDate()] = l.mood || 'üòä';
                }
            });
            
            let html = '';
            for (let i = 1; i <= daysInMonth; i++) {
                const mood = moodMap[i];
                const isToday = i === now.getDate();
                html += `<div class="h-8 flex items-center justify-center rounded ${isToday ? 'ring-2 ring-indigo-500' : ''} ${mood ? 'bg-white/10' : 'bg-white/5'}" title="Jour ${i}">
                    ${mood || '<span class="text-[8px] text-slate-600">' + i + '</span>'}
                </div>`;
            }
            
            calendar.innerHTML = html;
        }
        
        function updateWeekComparison() {
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
            
            const thisWeek = db.logs.filter(l => new Date(l.date) >= oneWeekAgo);
            const lastWeek = db.logs.filter(l => {
                const d = new Date(l.date);
                return d >= twoWeeksAgo && d < oneWeekAgo;
            });
            
            if (thisWeek.length > 0) {
                const twStress = (thisWeek.reduce((a, b) => a + b.stress, 0) / thisWeek.length).toFixed(1);
                const twSleep = (thisWeek.reduce((a, b) => a + b.sleep, 0) / thisWeek.length).toFixed(1);
                document.getElementById('this-week-stress').textContent = twStress;
                document.getElementById('this-week-sleep').textContent = twSleep;
                
                if (lastWeek.length > 0) {
                    const lwStress = (lastWeek.reduce((a, b) => a + b.stress, 0) / lastWeek.length).toFixed(1);
                    const lwSleep = (lastWeek.reduce((a, b) => a + b.sleep, 0) / lastWeek.length).toFixed(1);
                    document.getElementById('last-week-stress').textContent = lwStress;
                    document.getElementById('last-week-sleep').textContent = lwSleep;
                    
                    // Changes
                    const stressDiff = parseFloat(twStress) - parseFloat(lwStress);
                    const sleepDiff = parseFloat(twSleep) - parseFloat(lwSleep);
                    
                    const stressChange = document.getElementById('stress-change');
                    if (stressDiff < 0) {
                        stressChange.textContent = '‚Üì' + Math.abs(stressDiff).toFixed(1);
                        stressChange.className = 'text-xs font-bold text-emerald-400';
                    } else if (stressDiff > 0) {
                        stressChange.textContent = '‚Üë' + stressDiff.toFixed(1);
                        stressChange.className = 'text-xs font-bold text-red-400';
                    }
                    
                    const sleepChange = document.getElementById('sleep-change');
                    if (sleepDiff > 0) {
                        sleepChange.textContent = '‚Üë' + sleepDiff.toFixed(1);
                        sleepChange.className = 'text-xs font-bold text-emerald-400';
                    } else if (sleepDiff < 0) {
                        sleepChange.textContent = '‚Üì' + Math.abs(sleepDiff).toFixed(1);
                        sleepChange.className = 'text-xs font-bold text-red-400';
                    }
                }
            }
        }
        
        function shareStats() {
            // Create shareable text summary
            const avgStress = db.logs.length > 0 ? (db.logs.reduce((a,b) => a + b.stress, 0) / db.logs.length).toFixed(1) : 'N/A';
            const avgSleep = db.logs.length > 0 ? (db.logs.reduce((a,b) => a + b.sleep, 0) / db.logs.length).toFixed(1) : 'N/A';
            
            const text = `üéØ StudentFlow - Mes Stats

üìä Niveau: ${db.gamification.level}
‚ú® Sagesse: ${db.gamification.wisdom} pts
üî• Streak: ${db.gamification.streak} jours
üòå Stress moy: ${avgStress}/10
üò¥ Sommeil moy: ${avgSleep}h
üéØ Sessions Focus: ${db.focusSessions.length}

#StudentFlow #Productivit√© #Wellness`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'StudentFlow Stats',
                    text: text
                }).catch(() => {});
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(text).then(() => {
                    playSuccessSound();
                    showToast('üìã Stats copi√©es dans le presse-papier!');
                }).catch(() => {
                    showToast('‚ùå Impossible de copier');
                });
            }
        }

        // ==================== POMODORO AVANC√â ====================
        let focusPhase = 'work'; // 'work', 'shortBreak', 'longBreak'
        let ambientOscillator = null;
        let ambientGain = null;
        let ambientSound = 'rain';
        let ambientPlaying = false;
        let isExamMode = false;
        
        function startPomodoro() {
            if (pomodoroTimer) return;
            
            pomodoroActive = true;
            document.getElementById('start-btn').innerHTML = '<i data-lucide="pause" class="w-5 h-5 inline mr-2"></i> En cours...';
            lucide.createIcons();
            
            // Visibility API - pause si onglet inactif (optionnel)
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            pomodoroTimer = setInterval(() => {
                pomodoroSeconds--;
                updateTimerDisplay();
                
                if (pomodoroSeconds <= 0) {
                    completePomodoro();
                }
            }, 1000);
        }
        
        function handleVisibilityChange() {
            // Optionnel: on peut ajouter un param√®tre pour continuer ou pas
            // Pour l'instant on continue
        }

        function pausePomodoro() {
            if (!pomodoroTimer) return;
            clearInterval(pomodoroTimer);
            pomodoroTimer = null;
            pomodoroActive = false;
            document.getElementById('start-btn').innerHTML = '<i data-lucide="play" class="w-5 h-5 inline mr-2"></i> Reprendre';
            lucide.createIcons();
        }

        function resetPomodoro() {
            clearInterval(pomodoroTimer);
            pomodoroTimer = null;
            pomodoroSeconds = pomodoroInitial;
            pomodoroActive = false;
            focusPhase = 'work';
            isExamMode = false;
            updateTimerDisplay();
            updateSessionDots();
            document.getElementById('start-btn').innerHTML = '<i data-lucide="play" class="w-5 h-5 inline mr-2"></i> Start';
            document.getElementById('timer-phase').textContent = 'TRAVAIL';
            document.getElementById('focus-mode-label').textContent = 'Technique Pomodoro';
            document.getElementById('progress-circle').classList.remove('text-emerald-500', 'text-amber-500');
            document.getElementById('progress-circle').classList.add('text-indigo-500');
            lucide.createIcons();
        }

        function completePomodoro() {
            clearInterval(pomodoroTimer);
            pomodoroTimer = null;
            
            const tag = document.getElementById('focus-tag').value.trim() || 'Sans tag';
            
            if (focusPhase === 'work') {
                // Sauvegarder la session
                db.focusSessions.push({ 
                    date: new Date().toISOString(), 
                    duration: pomodoroInitial / 60,
                    tag: tag,
                    type: isExamMode ? 'exam' : 'pomodoro'
                });
                
                pomodoroSessionCount++;
                addWisdom(isExamMode ? 50 : 25, 'Session Focus');
                save();
                
                playSuccessSound();
                triggerConfetti();
                showToast(`üéâ Session termin√©e! +${isExamMode ? 50 : 25} Sagesse`, true);
                updateTodaySessions();
                updateSessionDots();
                
                if (isExamMode) {
                    // Mode examen termin√©
                    sendNotification('üìù Examen termin√©!', 'Excellent travail!');
                    resetPomodoro();
                } else {
                    // D√©marrer la pause
                    startBreak();
                }
            } else {
                // Pause termin√©e, retour au travail
                playNotificationSound();
                showToast('‚è∞ Pause termin√©e! Retour au travail');
                sendNotification('‚è∞ Pause termin√©e', 'C\'est reparti!');
                
                focusPhase = 'work';
                pomodoroSeconds = CONFIG.POMODORO.WORK * 60;
                pomodoroInitial = CONFIG.POMODORO.WORK * 60;
                document.getElementById('timer-phase').textContent = 'TRAVAIL';
                document.getElementById('progress-circle').classList.remove('text-emerald-500', 'text-amber-500');
                document.getElementById('progress-circle').classList.add('text-indigo-500');
                updateTimerDisplay();
            }
        }
        
        function startBreak() {
            const isLongBreak = pomodoroSessionCount % CONFIG.POMODORO.SESSIONS_BEFORE_LONG === 0;
            focusPhase = isLongBreak ? 'longBreak' : 'shortBreak';
            
            const breakDuration = isLongBreak ? CONFIG.POMODORO.LONG_BREAK : CONFIG.POMODORO.SHORT_BREAK;
            pomodoroSeconds = breakDuration * 60;
            pomodoroInitial = breakDuration * 60;
            
            document.getElementById('timer-phase').textContent = isLongBreak ? 'LONG BREAK' : 'PAUSE';
            document.getElementById('progress-circle').classList.remove('text-indigo-500');
            document.getElementById('progress-circle').classList.add(isLongBreak ? 'text-amber-500' : 'text-emerald-500');
            
            updateTimerDisplay();
            
            const msg = isLongBreak ? 'üéâ Long break m√©rit√©!' : '‚òï Petite pause!';
            sendNotification(msg, `${breakDuration} minutes de repos`);
            showToast(msg);
            
            // Auto-start la pause
            startPomodoro();
        }
        
        function updateSessionDots() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`session-dot-${i}`);
                if (dot) {
                    const sessionInCycle = pomodoroSessionCount % 4;
                    dot.className = `w-3 h-3 rounded-full ${i <= sessionInCycle ? 'bg-indigo-500' : 'bg-slate-700'}`;
                }
            }
        }

        function setCustomTimer(minutes) {
            pomodoroInitial = minutes * 60;
            pomodoroSeconds = pomodoroInitial;
            focusPhase = 'work';
            isExamMode = false;
            document.getElementById('timer-phase').textContent = 'TRAVAIL';
            document.getElementById('focus-mode-label').textContent = `${minutes} minutes de focus`;
            updateTimerDisplay();
        }
        
        function startExamMode(minutes) {
            isExamMode = true;
            pomodoroInitial = minutes * 60;
            pomodoroSeconds = pomodoroInitial;
            focusPhase = 'work';
            
            document.getElementById('timer-phase').textContent = 'EXAMEN';
            document.getElementById('focus-mode-label').textContent = `Mode Examen - ${minutes}min`;
            document.getElementById('progress-circle').classList.remove('text-indigo-500', 'text-emerald-500');
            document.getElementById('progress-circle').classList.add('text-amber-500');
            
            updateTimerDisplay();
            showToast(`üìù Mode Examen ${minutes}min activ√©`);
        }

        function updateTimerDisplay() {
            const m = Math.floor(pomodoroSeconds / 60);
            const s = pomodoroSeconds % 60;
            document.getElementById('timer-display').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            
            // Update progress ring
            const circle = document.getElementById('progress-circle');
            if (circle) {
                const progress = pomodoroSeconds / pomodoroInitial;
                const circumference = 565.48;
                circle.style.strokeDashoffset = circumference * (1 - progress);
            }
            
            // Update title
            if (pomodoroActive) {
                document.title = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')} - Focus | StudentFlow`;
            }
        }

        function updateTodaySessions() {
            const today = new Date().toISOString().slice(0, 10);
            const todayCount = db.focusSessions.filter(s => s.date.startsWith(today)).length;
            document.getElementById('today-sessions').textContent = todayCount;
        }
        
        // ==================== SONS AMBIANTS AM√âLIOR√âS ====================
        let ambientNodes = []; // Store all audio nodes for cleanup
        let ambientIntervals = []; // Store intervals for rain drops etc
        
        function setAmbientSound(type) {
            ambientSound = type;
            document.querySelectorAll('.ambient-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-500/30', 'ring-2', 'ring-indigo-500');
                if (btn.dataset.sound === type) {
                    btn.classList.add('bg-indigo-500/30', 'ring-2', 'ring-indigo-500');
                }
            });
            
            if (ambientPlaying) {
                stopAmbientSound();
                playAmbientSound();
            }
            showToast(`üéß Son: ${type === 'rain' ? 'Pluie' : type === 'cafe' ? 'Caf√©' : type === 'forest' ? 'For√™t' : 'Bruit blanc'}`);
        }
        
        function toggleAmbientSound() {
            if (ambientPlaying) {
                stopAmbientSound();
                showToast('üîá Son ambiant OFF');
            } else {
                playAmbientSound();
                showToast('üéß Son ambiant ON');
            }
        }
        
        function playAmbientSound() {
            try {
                const ctx = initAudio();
                if (ctx.state === 'suspended') ctx.resume();
                
                // Master gain for all ambient sounds
                ambientGain = ctx.createGain();
                ambientGain.gain.value = 0.15;
                ambientGain.connect(ctx.destination);
                
                switch(ambientSound) {
                    case 'rain':
                        createRainSound(ctx);
                        break;
                    case 'cafe':
                        createCafeSound(ctx);
                        break;
                    case 'forest':
                        createForestSound(ctx);
                        break;
                    case 'white':
                    default:
                        createWhiteNoise(ctx);
                        break;
                }
                
                ambientPlaying = true;
                document.getElementById('ambient-toggle').textContent = 'ON';
                document.getElementById('ambient-toggle').classList.add('bg-indigo-500/30');
            } catch(e) {
                console.error('Ambient sound error:', e);
            }
        }
        
        function createRainSound(ctx) {
            // Layer 1: Continuous rain background (brown noise)
            const bufferSize = 4 * ctx.sampleRate;
            const noiseBuffer = ctx.createBuffer(2, bufferSize, ctx.sampleRate);
            
            // Generate brown noise (more natural rain-like)
            for (let channel = 0; channel < 2; channel++) {
                const output = noiseBuffer.getChannelData(channel);
                let lastOut = 0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    output[i] = (lastOut + (0.02 * white)) / 1.02;
                    lastOut = output[i];
                    output[i] *= 3.5; // Boost
                }
            }
            
            const rainBase = ctx.createBufferSource();
            rainBase.buffer = noiseBuffer;
            rainBase.loop = true;
            
            // Rain filter - bandpass for that rain character
            const rainFilter = ctx.createBiquadFilter();
            rainFilter.type = 'bandpass';
            rainFilter.frequency.value = 800;
            rainFilter.Q.value = 0.5;
            
            const rainGain = ctx.createGain();
            rainGain.gain.value = 0.6;
            
            rainBase.connect(rainFilter);
            rainFilter.connect(rainGain);
            rainGain.connect(ambientGain);
            rainBase.start();
            
            ambientNodes.push(rainBase, rainFilter, rainGain);
            
            // Layer 2: Random droplets
            const dropletInterval = setInterval(() => {
                if (!ambientPlaying) return;
                createRainDroplet(ctx);
            }, 100 + Math.random() * 200);
            ambientIntervals.push(dropletInterval);
        }
        
        function createRainDroplet(ctx) {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.frequency.value = 2000 + Math.random() * 3000;
            osc.type = 'sine';
            
            gain.gain.setValueAtTime(0.02 + Math.random() * 0.03, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.05 + Math.random() * 0.1);
            
            osc.connect(gain);
            gain.connect(ambientGain);
            
            osc.start();
            osc.stop(ctx.currentTime + 0.15);
        }
        
        function createCafeSound(ctx) {
            // Layer 1: Low rumble (crowd murmur base)
            const bufferSize = 4 * ctx.sampleRate;
            const noiseBuffer = ctx.createBuffer(2, bufferSize, ctx.sampleRate);
            
            for (let channel = 0; channel < 2; channel++) {
                const output = noiseBuffer.getChannelData(channel);
                let lastOut = 0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    output[i] = (lastOut + (0.01 * white)) / 1.01;
                    lastOut = output[i];
                    output[i] *= 5;
                }
            }
            
            const murmurBase = ctx.createBufferSource();
            murmurBase.buffer = noiseBuffer;
            murmurBase.loop = true;
            
            const lowpass = ctx.createBiquadFilter();
            lowpass.type = 'lowpass';
            lowpass.frequency.value = 400;
            
            const murmurGain = ctx.createGain();
            murmurGain.gain.value = 0.4;
            
            murmurBase.connect(lowpass);
            lowpass.connect(murmurGain);
            murmurGain.connect(ambientGain);
            murmurBase.start();
            
            ambientNodes.push(murmurBase, lowpass, murmurGain);
            
            // Layer 2: Mid-frequency chatter
            const chatterBuffer = ctx.createBuffer(2, bufferSize, ctx.sampleRate);
            for (let channel = 0; channel < 2; channel++) {
                const output = chatterBuffer.getChannelData(channel);
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = (Math.random() * 2 - 1) * Math.sin(i * 0.0001) * 0.3;
                }
            }
            
            const chatter = ctx.createBufferSource();
            chatter.buffer = chatterBuffer;
            chatter.loop = true;
            
            const bandpass = ctx.createBiquadFilter();
            bandpass.type = 'bandpass';
            bandpass.frequency.value = 1200;
            bandpass.Q.value = 1;
            
            const chatterGain = ctx.createGain();
            chatterGain.gain.value = 0.15;
            
            chatter.connect(bandpass);
            bandpass.connect(chatterGain);
            chatterGain.connect(ambientGain);
            chatter.start();
            
            ambientNodes.push(chatter, bandpass, chatterGain);
            
            // Layer 3: Occasional cup clinks and sounds
            const clinkInterval = setInterval(() => {
                if (!ambientPlaying) return;
                if (Math.random() > 0.7) createCafeClink(ctx);
            }, 2000 + Math.random() * 3000);
            ambientIntervals.push(clinkInterval);
        }
        
        function createCafeClink(ctx) {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.frequency.value = 800 + Math.random() * 600;
            osc.type = 'triangle';
            
            gain.gain.setValueAtTime(0.02, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
            
            osc.connect(gain);
            gain.connect(ambientGain);
            
            osc.start();
            osc.stop(ctx.currentTime + 0.15);
        }
        
        function createForestSound(ctx) {
            // Layer 1: Wind/leaves rustling (pink noise)
            const bufferSize = 4 * ctx.sampleRate;
            const noiseBuffer = ctx.createBuffer(2, bufferSize, ctx.sampleRate);
            
            for (let channel = 0; channel < 2; channel++) {
                const output = noiseBuffer.getChannelData(channel);
                let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    b0 = 0.99886 * b0 + white * 0.0555179;
                    b1 = 0.99332 * b1 + white * 0.0750759;
                    b2 = 0.96900 * b2 + white * 0.1538520;
                    b3 = 0.86650 * b3 + white * 0.3104856;
                    b4 = 0.55000 * b4 + white * 0.5329522;
                    b5 = -0.7616 * b5 - white * 0.0168980;
                    output[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.11;
                    b6 = white * 0.115926;
                }
            }
            
            const windBase = ctx.createBufferSource();
            windBase.buffer = noiseBuffer;
            windBase.loop = true;
            
            const windFilter = ctx.createBiquadFilter();
            windFilter.type = 'lowpass';
            windFilter.frequency.value = 600;
            
            const windGain = ctx.createGain();
            windGain.gain.value = 0.5;
            
            // Add subtle modulation for wind gusts
            const lfo = ctx.createOscillator();
            const lfoGain = ctx.createGain();
            lfo.frequency.value = 0.2;
            lfoGain.gain.value = 0.15;
            lfo.connect(lfoGain);
            lfoGain.connect(windGain.gain);
            lfo.start();
            
            windBase.connect(windFilter);
            windFilter.connect(windGain);
            windGain.connect(ambientGain);
            windBase.start();
            
            ambientNodes.push(windBase, windFilter, windGain, lfo, lfoGain);
            
            // Layer 2: Bird chirps
            const birdInterval = setInterval(() => {
                if (!ambientPlaying) return;
                if (Math.random() > 0.6) createBirdChirp(ctx);
            }, 1500 + Math.random() * 3000);
            ambientIntervals.push(birdInterval);
        }
        
        function createBirdChirp(ctx) {
            const baseFreq = 2000 + Math.random() * 2000;
            const chirpCount = 1 + Math.floor(Math.random() * 3);
            
            for (let i = 0; i < chirpCount; i++) {
                setTimeout(() => {
                    if (!ambientPlaying) return;
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    
                    osc.frequency.setValueAtTime(baseFreq, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(baseFreq * 1.5, ctx.currentTime + 0.05);
                    osc.frequency.exponentialRampToValueAtTime(baseFreq * 0.8, ctx.currentTime + 0.1);
                    osc.type = 'sine';
                    
                    gain.gain.setValueAtTime(0.015, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.12);
                    
                    osc.connect(gain);
                    gain.connect(ambientGain);
                    
                    osc.start();
                    osc.stop(ctx.currentTime + 0.15);
                }, i * 120);
            }
        }
        
        function createWhiteNoise(ctx) {
            const bufferSize = 2 * ctx.sampleRate;
            const noiseBuffer = ctx.createBuffer(2, bufferSize, ctx.sampleRate);
            
            for (let channel = 0; channel < 2; channel++) {
                const output = noiseBuffer.getChannelData(channel);
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = Math.random() * 2 - 1;
                }
            }
            
            const whiteNoise = ctx.createBufferSource();
            whiteNoise.buffer = noiseBuffer;
            whiteNoise.loop = true;
            
            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 6000;
            
            const noiseGain = ctx.createGain();
            noiseGain.gain.value = 0.08;
            
            whiteNoise.connect(filter);
            filter.connect(noiseGain);
            noiseGain.connect(ambientGain);
            whiteNoise.start();
            
            ambientNodes.push(whiteNoise, filter, noiseGain);
        }
        
        function stopAmbientSound() {
            // Stop all nodes
            ambientNodes.forEach(node => {
                try {
                    if (node.stop) node.stop();
                    if (node.disconnect) node.disconnect();
                } catch(e) {}
            });
            ambientNodes = [];
            
            // Clear all intervals
            ambientIntervals.forEach(interval => clearInterval(interval));
            ambientIntervals = [];
            
            if (ambientOscillator) {
                try { ambientOscillator.stop(); } catch(e) {}
                ambientOscillator = null;
            }
            
            ambientPlaying = false;
            document.getElementById('ambient-toggle').textContent = 'OFF';
            document.getElementById('ambient-toggle').classList.remove('bg-indigo-500/30');
        }

        // ==================== JOURNAL AVANC√â ====================
        let journalData = {
            sleepQuality: 3,
            caffeine: 0,
            exercise: 'none',
            symptoms: []
        };
        
        function selectMood(mood) {
            selectedMood = mood;
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('selected', 'bg-white/10');
                if (btn.textContent === mood) {
                    btn.classList.add('selected', 'bg-white/10');
                }
            });
            checkJournalSuggestions();
        }
        
        function setQuickStress(value) {
            document.getElementById('in-stress').value = value;
            document.getElementById('stress-display').textContent = value;
            document.querySelectorAll('.quick-stress').forEach(btn => btn.classList.remove('ring-2', 'ring-white'));
            event.target.classList.add('ring-2', 'ring-white');
            checkJournalSuggestions();
        }
        
        function setQuickSleep(value) {
            document.getElementById('in-sleep').value = value;
            document.querySelectorAll('.quick-sleep').forEach(btn => btn.classList.remove('ring-2', 'ring-white'));
            event.target.classList.add('ring-2', 'ring-white');
            checkJournalSuggestions();
        }
        
        function setSleepQuality(value) {
            journalData.sleepQuality = value;
            document.querySelectorAll('.sleep-qual').forEach(btn => {
                btn.classList.remove('bg-white/10', 'ring-2', 'ring-indigo-500');
                if (parseInt(btn.dataset.val) === value) {
                    btn.classList.add('bg-white/10', 'ring-2', 'ring-indigo-500');
                }
            });
        }
        
        function setCaffeine(value) {
            journalData.caffeine = value;
            document.querySelectorAll('.caffeine-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-500/30', 'ring-2', 'ring-indigo-500');
                if (parseInt(btn.dataset.val) === value) {
                    btn.classList.add('bg-indigo-500/30', 'ring-2', 'ring-indigo-500');
                }
            });
        }
        
        function setExercise(value) {
            journalData.exercise = value;
            document.querySelectorAll('.exercise-btn').forEach(btn => {
                btn.classList.remove('bg-emerald-500/30', 'ring-2', 'ring-emerald-500');
                if (btn.dataset.val === value) {
                    btn.classList.add('bg-emerald-500/30', 'ring-2', 'ring-emerald-500');
                }
            });
        }
        
        function toggleSymptom(symptom) {
            const idx = journalData.symptoms.indexOf(symptom);
            if (idx > -1) {
                journalData.symptoms.splice(idx, 1);
            } else {
                journalData.symptoms.push(symptom);
            }
            
            document.querySelectorAll('.symptom-btn').forEach(btn => {
                btn.classList.remove('bg-red-500/30', 'ring-2', 'ring-red-500');
                if (journalData.symptoms.includes(btn.dataset.val)) {
                    btn.classList.add('bg-red-500/30', 'ring-2', 'ring-red-500');
                }
            });
        }
        
        function checkJournalSuggestions() {
            const stress = parseInt(document.getElementById('in-stress').value);
            const sleep = parseFloat(document.getElementById('in-sleep').value) || 0;
            const suggestionEl = document.getElementById('journal-suggestion');
            const textEl = document.getElementById('suggestion-text');
            
            let suggestion = '';
            
            // Suggestions bas√©es sur les donn√©es
            const stats = Helpers.getRecentStats(5);
            
            if (sleep > 0 && sleep < 6 && stats.avgSleep < 6.5) {
                suggestion = `üí° Tu dors ${stats.avgSleep.toFixed(1)}h en moyenne depuis 5 jours. Essaie de te coucher 30 min plus t√¥t ce soir.`;
            } else if (stress > 7 && stats.avgStress > 6) {
                suggestion = `üí° Ton stress est √©lev√© depuis plusieurs jours. L'exercice de coh√©rence cardiaque peut aider (onglet Zen).`;
            } else if (sleep >= 8 && stress <= 3) {
                suggestion = `üåü Excellent √©quilibre! Continue comme √ßa.`;
            }
            
            if (suggestion) {
                textEl.textContent = suggestion;
                suggestionEl.classList.remove('hidden');
            } else {
                suggestionEl.classList.add('hidden');
            }
        }

        function saveEntry() {
            const stress = parseInt(document.getElementById('in-stress').value);
            const sleep = parseFloat(document.getElementById('in-sleep').value) || 0;
            const note = document.getElementById('in-note').value.trim();
            const screenTime = parseFloat(document.getElementById('in-screen')?.value) || 0;
            
            if (sleep <= 0) {
                playAlertSound();
                showToast('‚ö†Ô∏è Entre tes heures de sommeil');
                return;
            }
            
            if (sleep < 0 || sleep > 24) {
                playAlertSound();
                showToast('‚ö†Ô∏è Heures de sommeil invalides');
                return;
            }
            
            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            
            db.logs.push({ 
                id: Helpers.genId(),
                date: new Date().toISOString(), 
                day: days[new Date().getDay()], 
                stress, 
                sleep,
                sleepQuality: journalData.sleepQuality,
                mood: selectedMood,
                caffeine: journalData.caffeine,
                exercise: journalData.exercise,
                screenTime,
                symptoms: [...journalData.symptoms],
                note
            });
            
            if (db.logs.length > 90) db.logs = db.logs.slice(-90);
            
            updateStreak();
            
            // Points bonus selon qualit√©
            let wisdomPoints = 5;
            let reason = 'Entr√©e journal';
            
            if (stress <= 4 && sleep >= 7.5) {
                wisdomPoints = 20;
                reason = '√âquilibre parfait!';
            } else if (stress <= 5 && sleep >= 7) {
                wisdomPoints = 15;
                reason = 'Bon √©quilibre';
            }
            
            if (journalData.exercise === 'moderate' || journalData.exercise === 'intense') {
                wisdomPoints += 5;
                reason += ' + Sport';
            }
            
            addWisdom(wisdomPoints, reason);
            
            save();
            checkSafeMode();
            
            // Reset form
            resetJournalForm();
            
            playSuccessSound();
            showToast('‚úÖ Journal synchronis√©!', true);
            
            switchTab('dash');
            refreshAll();
            updateAnalytics();
        }
        
        function resetJournalForm() {
            document.getElementById('in-stress').value = 5;
            document.getElementById('stress-display').textContent = '5';
            document.getElementById('in-sleep').value = '';
            document.getElementById('in-note').value = '';
            const screenInput = document.getElementById('in-screen');
            if (screenInput) screenInput.value = '';
            
            selectMood('üòä');
            journalData = { sleepQuality: 3, caffeine: 0, exercise: 'none', symptoms: [] };
            
            // Reset all button highlights
            document.querySelectorAll('.quick-stress, .quick-sleep').forEach(btn => btn.classList.remove('ring-2', 'ring-white'));
            document.querySelectorAll('.sleep-qual').forEach(btn => {
                btn.classList.remove('bg-white/10', 'ring-2', 'ring-indigo-500');
                if (btn.dataset.val === '3') btn.classList.add('bg-white/10');
            });
            document.querySelectorAll('.caffeine-btn, .exercise-btn').forEach(btn => btn.classList.remove('bg-indigo-500/30', 'bg-emerald-500/30', 'ring-2'));
            document.querySelectorAll('.symptom-btn').forEach(btn => btn.classList.remove('bg-red-500/30', 'ring-2', 'ring-red-500'));
            
            document.getElementById('journal-suggestion').classList.add('hidden');
        }

        // ==================== GOALS ====================
        function renderGoals() {
            const container = document.getElementById('goals-list');
            if (!container) return;
            
            if (db.goals.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 py-8">Aucun objectif. Clique sur "+ Ajouter"</p>';
                updateGoalStats();
                return;
            }
            
            container.innerHTML = db.goals.map((goal, i) => `
                <div class="glass p-4 flex items-center gap-4 ${goal.completed ? 'opacity-60' : ''}">
                    <button onclick="toggleGoal(${i})" class="w-8 h-8 rounded-full border-2 ${goal.completed ? 'bg-emerald-500 border-emerald-500' : 'border-slate-600'} flex items-center justify-center touch-feedback">
                        ${goal.completed ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}
                    </button>
                    <div class="flex-1">
                        <p class="font-bold ${goal.completed ? 'line-through' : ''}">${goal.text}</p>
                        <p class="text-xs text-slate-400">${goal.category}</p>
                    </div>
                    <button onclick="deleteGoal(${i})" class="text-red-400 hover:text-red-500 touch-feedback">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            `).join('');
            
            lucide.createIcons();
            updateGoalStats();
        }

        function addGoal() {
            const text = prompt('Nouvel objectif:');
            if (!text) return;
            
            const category = prompt('Cat√©gorie (√âtudes/Sant√©/Personnel):', '√âtudes') || '√âtudes';
            
            db.goals.push({ text, category, completed: false, created: new Date().toISOString() });
            save();
            renderGoals();
            playNotificationSound();
            showToast('üéØ Objectif ajout√©');
        }

        function toggleGoal(index) {
            db.goals[index].completed = !db.goals[index].completed;
            if (db.goals[index].completed) {
                addWisdom(10, 'Objectif atteint!');
            }
            save();
            renderGoals();
        }

        function deleteGoal(index) {
            db.goals.splice(index, 1);
            save();
            renderGoals();
        }

        function updateGoalStats() {
            const completed = db.goals.filter(g => g.completed).length;
            const progress = db.goals.filter(g => !g.completed).length;
            const total = db.goals.length;
            
            document.getElementById('goals-completed').textContent = completed;
            document.getElementById('goals-progress').textContent = progress;
            document.getElementById('goals-total').textContent = total;
        }

        // ==================== WELLNESS ====================
        function updateWellnessRecommendations() {
            const container = document.getElementById('wellness-recommendations');
            if (!container || db.logs.length === 0) return;
            
            const last = db.logs[db.logs.length - 1];
            const recs = [];
            
            if (last.stress > 7) {
                recs.push({ icon: 'ü´Å', title: 'Coh√©rence Cardiaque', desc: 'R√©duis ton stress en 5 minutes' });
            }
            if (last.sleep < 6.5) {
                recs.push({ icon: 'üò¥', title: 'Sieste Flash', desc: '20 minutes pour r√©cup√©rer' });
            }
            if (last.stress > 5) {
                recs.push({ icon: 'üßò', title: '√âtirements', desc: 'Rel√¢che les tensions musculaires' });
            }
            
            if (recs.length === 0) {
                container.innerHTML = '<div class="text-center text-emerald-500 py-4"><span class="text-4xl">‚ú®</span><p class="font-bold mt-2">√âtat Optimal!</p></div>';
            } else {
                container.innerHTML = recs.map(r => `
                    <div class="glass p-4 flex items-center gap-4">
                        <span class="text-3xl">${r.icon}</span>
                        <div>
                            <p class="font-bold">${r.title}</p>
                            <p class="text-xs text-slate-400">${r.desc}</p>
                        </div>
                    </div>
                `).join('');
            }
        }

        function startBreathing() {
            if (breathingInterval) {
                clearInterval(breathingInterval);
                breathingInterval = null;
                document.getElementById('breathing-btn').textContent = 'Commencer';
                document.getElementById('breathing-text').textContent = 'Pr√™t';
                document.getElementById('breathing-circle').style.transform = 'scale(1)';
                return;
            }
            
            let phase = 'inspire';
            const circle = document.getElementById('breathing-circle');
            const text = document.getElementById('breathing-text');
            document.getElementById('breathing-btn').textContent = 'Arr√™ter';
            
            function animate() {
                if (phase === 'inspire') {
                    text.textContent = 'Inspirez...';
                    circle.style.transform = 'scale(1.5)';
                    phase = 'expire';
                } else {
                    text.textContent = 'Expirez...';
                    circle.style.transform = 'scale(1)';
                    phase = 'inspire';
                }
            }
            
            animate();
            breathingInterval = setInterval(animate, 5000);
            
            setTimeout(() => {
                if (breathingInterval) {
                    clearInterval(breathingInterval);
                    breathingInterval = null;
                    document.getElementById('breathing-btn').textContent = 'Commencer';
                    text.textContent = 'Termin√©!';
                    circle.style.transform = 'scale(1)';
                    addWisdom(10, 'Exercice respiration');
                }
            }, 120000);
        }

        function showTip(type) {
            const tips = {
                stretching: 'üßò √âtire tes √©paules, ton cou et ton dos. 30 secondes par zone. R√©p√®te toutes les heures!',
                hydration: 'üíß Bois un grand verre d\'eau maintenant! Objectif: 2L par jour pour une concentration optimale.',
                eyes: 'üëÄ R√®gle 20-20-20: Toutes les 20 min, regarde √† 20 pieds (6m) pendant 20 secondes.',
                walk: 'üö∂ L√®ve-toi et marche 2 minutes. √áa booste la cr√©ativit√© de 60%!'
            };
            
            showToast(tips[type]);
            addWisdom(5, 'Bio-hack activ√©');
        }
        
        // ==================== REMINDERS SYSTEM ====================
        let reminderIntervals = {};
        let remindersActive = false;
        
        function toggleReminders() {
            remindersActive = !remindersActive;
            const btn = document.getElementById('reminder-toggle');
            const status = document.getElementById('reminder-status');
            
            if (remindersActive) {
                btn.textContent = 'D√©sactiver';
                btn.classList.remove('bg-amber-500/20', 'text-amber-400');
                btn.classList.add('bg-emerald-500/20', 'text-emerald-400');
                status.textContent = '‚úÖ Rappels actifs';
                status.classList.add('text-emerald-400');
                startReminders();
                playNotificationSound();
                showToast('üîî Rappels activ√©s!');
            } else {
                btn.textContent = 'Activer';
                btn.classList.remove('bg-emerald-500/20', 'text-emerald-400');
                btn.classList.add('bg-amber-500/20', 'text-amber-400');
                status.textContent = 'Rappels d√©sactiv√©s';
                status.classList.remove('text-emerald-400');
                stopReminders();
                showToast('üîï Rappels d√©sactiv√©s');
            }
        }
        
        function startReminders() {
            // Hydratation - toutes les 45 min
            if (document.getElementById('remind-water').checked) {
                reminderIntervals.water = setInterval(() => {
                    sendReminder('üíß Hydratation', 'Bois un verre d\'eau!');
                }, 45 * 60 * 1000);
            }
            
            // Yeux - toutes les 20 min
            if (document.getElementById('remind-eyes').checked) {
                reminderIntervals.eyes = setInterval(() => {
                    sendReminder('üëÄ Pause Yeux', 'Regarde au loin pendant 20 secondes');
                }, 20 * 60 * 1000);
            }
            
            // √âtirement - toutes les heures
            if (document.getElementById('remind-stretch').checked) {
                reminderIntervals.stretch = setInterval(() => {
                    sendReminder('üßò √âtirement', 'L√®ve-toi et √©tire-toi!');
                }, 60 * 60 * 1000);
            }
            
            // Journal - √† 21h
            if (document.getElementById('remind-journal').checked) {
                checkJournalReminder();
                reminderIntervals.journal = setInterval(checkJournalReminder, 60 * 1000);
            }
        }
        
        function stopReminders() {
            Object.values(reminderIntervals).forEach(interval => clearInterval(interval));
            reminderIntervals = {};
        }
        
        function checkJournalReminder() {
            const now = new Date();
            if (now.getHours() === 21 && now.getMinutes() === 0) {
                sendReminder('üìù Journal', 'N\'oublie pas de remplir ton journal!');
            }
        }
        
        function sendReminder(title, body) {
            playNotificationSound();
            showToast(`${title}: ${body}`);
            
            if (db.settings.notifications && Notification.permission === 'granted') {
                new Notification(title, { body, icon: 'üéØ' });
            }
        }

        // ==================== DATA MANAGEMENT ====================
        function openDataModal() {
            document.getElementById('data-modal').style.display = 'flex';
            
            // Update data info display
            const formatDate = (iso) => {
                if (!iso) return '-';
                return new Date(iso).toLocaleDateString('fr-FR', { 
                    day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
            };
            
            document.getElementById('data-schema-version').textContent = db.schemaVersion || 1;
            document.getElementById('data-created-at').textContent = formatDate(db.createdAt);
            document.getElementById('data-last-modified').textContent = formatDate(db.lastModified);
            
            lucide.createIcons();
        }

        function closeDataModal() {
            document.getElementById('data-modal').style.display = 'none';
        }
        
        function deleteAllData() {
            const confirmText = prompt('‚ö†Ô∏è ATTENTION: Cette action est IRR√âVERSIBLE!\n\nTapez "SUPPRIMER" pour confirmer:');
            if (confirmText !== 'SUPPRIMER') {
                showToast('‚ùå Suppression annul√©e');
                return;
            }
            
            // Clear all localStorage keys related to the app
            localStorage.removeItem(CONFIG.STORAGE_KEY);
            
            // Also clear any backup keys
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith(CONFIG.STORAGE_KEY)) {
                    localStorage.removeItem(key);
                }
            });
            
            playAlertSound();
            showToast('üóëÔ∏è Toutes les donn√©es supprim√©es');
            
            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        function exportJSON() {
            const data = JSON.stringify(db, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `StudentFlow_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            playSuccessSound();
            showToast('üíæ Backup JSON export√©');
            closeDataModal();
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.timetable && imported.logs) {
                        db = imported;
                        save();
                        location.reload();
                        } else {
                            playAlertSound();
                            showToast('‚ùå Fichier invalide');
                        }
                    } catch (err) {
                        playAlertSound();
                        showToast('‚ùå Erreur de lecture');
                    }
            };
            reader.readAsText(file);
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            let y = 20;
            
            // Helper functions
            const addTitle = (text, size = 16) => {
                doc.setFontSize(size);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(99, 102, 241); // Indigo
                doc.text(text, margin, y);
                y += size * 0.6;
                doc.setTextColor(0, 0, 0);
            };
            
            const addText = (text, indent = 0) => {
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(text, margin + indent, y);
                y += 6;
            };
            
            const addLine = () => {
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, y, pageWidth - margin, y);
                y += 8;
            };
            
            const checkNewPage = (needed = 30) => {
                if (y > 270 - needed) {
                    doc.addPage();
                    y = 20;
                }
            };

            // Calculate statistics
            const avgStress = db.logs.length ? (db.logs.reduce((a,b) => a + b.stress, 0) / db.logs.length).toFixed(1) : 'N/A';
            const avgSleep = db.logs.length ? (db.logs.reduce((a,b) => a + b.sleep, 0) / db.logs.length).toFixed(1) : 'N/A';
            const totalFocusMinutes = db.focusSessions.reduce((a,b) => a + (b.duration || 0), 0);
            const totalFocusHours = (totalFocusMinutes / 60).toFixed(1);
            const completedGoals = db.goals.filter(g => g.completed).length;
            
            // Slot type analysis
            const slotTypes = {};
            Object.values(db.timetable).forEach(slot => {
                slotTypes[slot.type] = (slotTypes[slot.type] || 0) + 1;
            });

            // === HEADER ===
            doc.setFillColor(99, 102, 241);
            doc.rect(0, 0, pageWidth, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("STUDENTFLOW", pageWidth / 2, 18, { align: 'center' });
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text("Bilan Sant√© & Productivit√©", pageWidth / 2, 28, { align: 'center' });
            doc.setFontSize(9);
            doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}`, pageWidth / 2, 36, { align: 'center' });
            doc.setTextColor(0, 0, 0);
            y = 55;

            // === PROFIL √âTUDIANT ===
            addTitle("PROFIL √âTUDIANT", 14);
            y += 2;
            
            doc.setFillColor(245, 245, 250);
            doc.roundedRect(margin, y - 4, pageWidth - margin * 2, 28, 3, 3, 'F');
            
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text(`Niveau ${db.gamification.level}`, margin + 8, y + 4);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            doc.text(`${db.gamification.wisdom} points sagesse`, margin + 8, y + 12);
            doc.text(`Streak: ${db.gamification.streak} jours`, margin + 8, y + 20);
            
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text("Bien-√™tre", margin + 70, y + 4);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            doc.text(`Stress moyen: ${avgStress}/10`, margin + 70, y + 12);
            doc.text(`Sommeil moyen: ${avgSleep}h`, margin + 70, y + 20);
            
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text("Productivit√©", margin + 130, y + 4);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            doc.text(`${db.focusSessions.length} sessions focus`, margin + 130, y + 12);
            doc.text(`${totalFocusHours}h de concentration`, margin + 130, y + 20);
            
            y += 35;

            // === PLANNING HEBDO ===
            addTitle("PLANNING HEBDOMADAIRE", 14);
            y += 2;
            
            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            const slotsByDay = {};
            days.forEach((d, i) => slotsByDay[i] = []);
            
            Object.entries(db.timetable).forEach(([key, slot]) => {
                const [hour, day] = key.split('-').map(Number);
                if (slotsByDay[day]) {
                    slotsByDay[day].push({ hour, ...slot });
                }
            });
            
            days.forEach((dayName, dayIndex) => {
                const daySlots = slotsByDay[dayIndex].sort((a, b) => a.hour - b.hour);
                if (daySlots.length > 0) {
                    checkNewPage(20);
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.text(dayName, margin, y);
                    y += 5;
                    
                    daySlots.forEach(slot => {
                        const typeEmoji = CONFIG.SLOT_TYPES[slot.type]?.emoji || 'üìå';
                        const timeStr = `${String(slot.hour).padStart(2, '0')}h-${String(slot.hour + 1).padStart(2, '0')}h`;
                        doc.setFont("helvetica", "normal");
                        doc.setFontSize(9);
                        doc.text(`  ${timeStr}: ${slot.label || slot.type} (${slot.type})`, margin, y);
                        y += 5;
                    });
                    y += 3;
                }
            });
            
            if (Object.keys(db.timetable).length === 0) {
                addText("Aucun cr√©neau planifi√©", 5);
            }
            
            y += 5;
            addLine();

            // === R√âPARTITION DES ACTIVIT√âS ===
            checkNewPage(40);
            addTitle("R√âPARTITION DES ACTIVIT√âS", 14);
            y += 2;
            
            if (Object.keys(slotTypes).length > 0) {
                Object.entries(slotTypes).forEach(([type, count]) => {
                    const typeName = CONFIG.SLOT_TYPES[type]?.label || type;
                    const emoji = CONFIG.SLOT_TYPES[type]?.emoji || 'üìå';
                    addText(`${emoji} ${typeName}: ${count}h/semaine`, 5);
                });
            } else {
                addText("Aucune donn√©e", 5);
            }
            
            y += 5;
            addLine();

            // === OBJECTIFS ===
            checkNewPage(50);
            addTitle("OBJECTIFS", 14);
            y += 2;
            
            if (db.goals.length > 0) {
                addText(`${completedGoals}/${db.goals.length} objectifs compl√©t√©s`, 5);
                y += 3;
                db.goals.slice(0, 8).forEach(goal => {
                    const status = goal.completed ? '‚úÖ' : '‚è≥';
                    const progress = goal.progress || 0;
                    addText(`${status} ${goal.title} (${progress}%)`, 5);
                });
                if (db.goals.length > 8) {
                    addText(`... et ${db.goals.length - 8} autres objectifs`, 5);
                }
            } else {
                addText("Aucun objectif d√©fini", 5);
            }
            
            y += 5;
            addLine();

            // === HISTORIQUE BIEN-√äTRE ===
            checkNewPage(70);
            addTitle("HISTORIQUE BIEN-√äTRE (14 derniers jours)", 14);
            y += 2;
            
            if (db.logs.length > 0) {
                const recent = db.logs.slice(-14);
                
                // Table header
                doc.setFillColor(240, 240, 245);
                doc.rect(margin, y - 3, pageWidth - margin * 2, 8, 'F');
                doc.setFontSize(9);
                doc.setFont("helvetica", "bold");
                doc.text("Date", margin + 3, y + 2);
                doc.text("Stress", margin + 45, y + 2);
                doc.text("Sommeil", margin + 70, y + 2);
                doc.text("Humeur", margin + 100, y + 2);
                doc.text("Notes", margin + 125, y + 2);
                y += 10;
                
                doc.setFont("helvetica", "normal");
                recent.forEach((log) => {
                    checkNewPage(10);
                    const stressColor = log.stress > 7 ? [220, 38, 38] : log.stress > 4 ? [234, 179, 8] : [34, 197, 94];
                    doc.setTextColor(...stressColor);
                    doc.text(log.day || '-', margin + 3, y);
                    doc.text(`${log.stress}/10`, margin + 45, y);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`${log.sleep}h`, margin + 70, y);
                    doc.text(log.mood || '-', margin + 100, y);
                    const notePreview = log.notes ? log.notes.substring(0, 20) + (log.notes.length > 20 ? '...' : '') : '-';
                    doc.text(notePreview, margin + 125, y);
                    y += 6;
                });
            } else {
                addText("Aucune entr√©e de journal", 5);
            }
            
            y += 5;
            addLine();

            // === SESSIONS FOCUS ===
            checkNewPage(50);
            addTitle("SESSIONS FOCUS R√âCENTES", 14);
            y += 2;
            
            if (db.focusSessions.length > 0) {
                addText(`Total: ${db.focusSessions.length} sessions | ${totalFocusHours}h de concentration`, 5);
                y += 3;
                
                const recentSessions = db.focusSessions.slice(-10);
                recentSessions.forEach(session => {
                    const date = session.date ? new Date(session.date).toLocaleDateString('fr-FR') : '-';
                    const duration = session.duration || 0;
                    const type = session.type || 'focus';
                    addText(`${date}: ${duration} min (${type})`, 5);
                });
                
                if (db.focusSessions.length > 10) {
                    addText(`... et ${db.focusSessions.length - 10} autres sessions`, 5);
                }
            } else {
                addText("Aucune session de focus enregistr√©e", 5);
            }

            // === FOOTER ===
            doc.setFontSize(8);
            doc.setFont("helvetica", "italic");
            doc.setTextColor(150, 150, 150);
            doc.text("Document confidentiel - StudentFlow Ultimate Pro", pageWidth / 2, 285, { align: 'center' });
            doc.text("Ce bilan peut √™tre partag√© avec un professionnel de sant√© si n√©cessaire", pageWidth / 2, 290, { align: 'center' });

            doc.save(`StudentFlow_Bilan_${new Date().toISOString().split('T')[0]}.pdf`);
            playSuccessSound();
            showToast('üìÑ PDF export√© avec succ√®s');
            closeDataModal();
        }

        // ==================== EXPORT GOOGLE CALENDAR (.ICS) ====================
        function exportCalendar() {
            if (Object.keys(db.timetable).length === 0) {
                showToast('‚ö†Ô∏è Aucun cr√©neau √† exporter');
                return;
            }
            
            // Get the current week's Monday
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            monday.setHours(0, 0, 0, 0);
            
            // ICS file header
            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//StudentFlow//Ultimate Pro//FR',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'X-WR-CALNAME:StudentFlow Planning',
                'X-WR-TIMEZONE:Europe/Paris'
            ].join('\r\n') + '\r\n';
            
            // Add timezone definition
            icsContent += [
                'BEGIN:VTIMEZONE',
                'TZID:Europe/Paris',
                'BEGIN:DAYLIGHT',
                'TZOFFSETFROM:+0100',
                'TZOFFSETTO:+0200',
                'TZNAME:CEST',
                'DTSTART:19700329T020000',
                'RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU',
                'END:DAYLIGHT',
                'BEGIN:STANDARD',
                'TZOFFSETFROM:+0200',
                'TZOFFSETTO:+0100',
                'TZNAME:CET',
                'DTSTART:19701025T030000',
                'RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU',
                'END:STANDARD',
                'END:VTIMEZONE'
            ].join('\r\n') + '\r\n';
            
            // Process each slot
            Object.entries(db.timetable).forEach(([key, slot]) => {
                const [hour, dayIndex] = key.split('-').map(Number);
                
                // Calculate the date for this slot
                const slotDate = new Date(monday);
                slotDate.setDate(monday.getDate() + dayIndex);
                slotDate.setHours(hour, 0, 0, 0);
                
                const endDate = new Date(slotDate);
                endDate.setHours(hour + 1, 0, 0, 0);
                
                // Format dates for ICS (YYYYMMDDTHHMMSS)
                const formatICSDate = (date) => {
                    return date.toISOString().replace(/[-:]/g, '').split('.')[0];
                };
                
                // Get slot info
                const typeInfo = CONFIG.SLOT_TYPES[slot.type] || { label: slot.type, emoji: 'üìå' };
                const title = slot.label || typeInfo.label;
                const emoji = typeInfo.emoji;
                const uid = `${key}-${Date.now()}@studentflow`;
                
                // Create event
                icsContent += [
                    'BEGIN:VEVENT',
                    `UID:${uid}`,
                    `DTSTAMP:${formatICSDate(new Date())}`,
                    `DTSTART;TZID=Europe/Paris:${formatICSDate(slotDate)}`,
                    `DTEND;TZID=Europe/Paris:${formatICSDate(endDate)}`,
                    `SUMMARY:${emoji} ${title}`,
                    `DESCRIPTION:Type: ${typeInfo.label}\\nCr√©√© par StudentFlow`,
                    `CATEGORIES:${slot.type.toUpperCase()}`,
                    'STATUS:CONFIRMED',
                    'TRANSP:OPAQUE',
                    // Add weekly recurrence
                    'RRULE:FREQ=WEEKLY;COUNT=12',
                    'END:VEVENT'
                ].join('\r\n') + '\r\n';
            });
            
            icsContent += 'END:VCALENDAR';
            
            // Download the file
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `StudentFlow_Planning_${new Date().toISOString().split('T')[0]}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            playSuccessSound();
            showToast('üìÖ Calendrier export√© ! Importez-le dans Google Calendar');
            closeDataModal();
        }

        // ==================== MAIN REFRESH ====================
        function refreshAll() {
            // Stats
            document.getElementById('h-count').innerText = Object.keys(db.timetable).length;
            
            if (db.logs.length > 0) {
                const last = db.logs[db.logs.length - 1];
                const avgSleep = (db.logs.reduce((a, b) => a + b.sleep, 0) / db.logs.length).toFixed(1);
                
                document.getElementById('s-count').innerText = last.stress;
                document.getElementById('stress-bar').style.width = (last.stress * 10) + '%';
                document.getElementById('sleep-avg').innerText = avgSleep + 'h';
                
                updateAIInsights();
            }
            
            updateChart();
            predictStress();
            analyzeChronotype();
            updateWellnessRecommendations();
            updateTodaySessions();
        }

        function updateChart() {
            const ctx = document.getElementById('main-chart');
            if (!ctx) return;
            if (chart) chart.destroy();
            
            const last7 = db.logs.slice(-7);
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7.map(l => l.day || '?'),
                    datasets: [
                        { label: 'Stress', data: last7.map(l => l.stress), borderColor: '#f43f5e', backgroundColor: 'rgba(244, 63, 94, 0.1)', fill: true, tension: 0.4 },
                        { label: 'Sommeil', data: last7.map(l => l.sleep), borderColor: '#6366f1', tension: 0.4, borderDash: [5, 5] }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#475569' } },
                        x: { grid: { display: false }, ticks: { color: '#475569' } }
                    }
                }
            });
        }

        function analyzeChronotype() {
            const container = document.getElementById('chronotype-analysis');
            if (!container || db.logs.length < 3) {
                if (container) container.innerHTML = '<p class="text-slate-500">Remplis au moins 3 jours...</p>';
                return;
            }
            
            const avgStress = db.logs.reduce((a, b) => a + b.stress, 0) / db.logs.length;
            const avgSleep = db.logs.reduce((a, b) => a + b.sleep, 0) / db.logs.length;
            
            let profile = '‚òÄÔ∏è Profil √âquilibr√©';
            let advice = 'Maintiens ton rythme actuel.';
            
            if (avgSleep > 7.5 && avgStress < 5) {
                profile = 'üåü Profil Optimal';
                advice = 'Excellent √©quilibre! Tu peux augmenter ta charge si besoin.';
            } else if (avgSleep < 6) {
                profile = 'üò¥ Profil Fatigu√©';
                advice = 'Priorit√© au sommeil! Vise 7-8h par nuit.';
            } else if (avgStress > 7) {
                profile = '‚ö° Profil Sous Tension';
                advice = 'Int√®gre plus de pauses et d\'exercices de respiration.';
            }
            
            container.innerHTML = `
                <div class="glass p-4 bg-indigo-500/10">
                    <p class="font-bold text-lg">${profile}</p>
                    <p class="text-sm text-slate-400 mt-2">${advice}</p>
                </div>
            `;
        }

        function updateAIInsights() {
            const insight = document.getElementById('ai-insight');
            const tags = document.getElementById('ai-tags');
            if (!insight || !tags) return;

            const load = Object.values(db.timetable).filter(i => i.type !== 'repos').length;
            const last = db.logs[db.logs.length - 1];
            const avgStress = db.logs.reduce((a,b) => a + b.stress, 0) / db.logs.length;

            let msg = "Continue de remplir ton journal pour des conseils personnalis√©s!";
            const badges = [];

            if (last) {
                if (last.sleep < 5.5 && last.stress > 8) {
                    msg = "üö® ALERTE: Combinaison dangereuse sommeil/stress. Repos IMM√âDIAT recommand√©.";
                    badges.push({ text: "CRITIQUE", color: "red" });
                } else if (last.sleep < 6) {
                    msg = "üò¥ D√©ficit de sommeil d√©tect√©. Couche-toi 30min plus t√¥t ce soir.";
                    badges.push({ text: "Sommeil", color: "amber" });
                } else if (last.stress > 7) {
                    msg = "üò∞ Stress √©lev√©. Essaie l'exercice de coh√©rence cardiaque dans Bio-Hack.";
                    badges.push({ text: "Stress", color: "pink" });
                } else if (last.sleep >= 7 && last.stress <= 4) {
                    msg = "‚ú® PARFAIT! Ton √©quilibre est optimal. Continue comme √ßa!";
                    badges.push({ text: "OPTIMAL", color: "emerald" });
                } else {
                    msg = "üëç √âquilibre correct. Quelques ajustements peuvent t'amener au niveau sup√©rieur.";
                    badges.push({ text: "Stable", color: "indigo" });
                }
            }

            if (load > 30) {
                badges.push({ text: "Surcharge", color: "orange" });
            }

            if (db.gamification.streak >= 7) {
                badges.push({ text: `üî• ${db.gamification.streak}j`, color: "amber" });
            }

            insight.textContent = msg;
            tags.innerHTML = badges.map(b => 
                `<span class="px-3 py-1 text-[10px] font-bold rounded-full bg-${b.color}-500/20 text-${b.color}-400">${b.text}</span>`
            ).join('');
        }

        // ==================== NAVIGATION ====================
        function switchTab(id) {
            document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('nav button, .mobile-nav button').forEach(b => {
                b.classList.remove('nav-active', 'active');
            });
            
            document.getElementById(id).classList.add('active');
            
            // Desktop nav
            const deskBtn = document.getElementById('btn-' + id);
            if (deskBtn) deskBtn.classList.add('nav-active');
            
            // Mobile nav
            const mobBtn = document.getElementById('mob-' + id);
            if (mobBtn) mobBtn.classList.add('active');
            
            if (id === 'dash') refreshAll();
            if (id === 'analytics') updateAnalytics();
            
            lucide.createIcons();
        }

        // ==================== MOBILE MORE MENU ====================
        function toggleMobileMore() {
            const menu = document.getElementById('mobile-more-menu');
            menu.classList.toggle('hidden');
            lucide.createIcons();
        }
        
        function closeMobileMore() {
            document.getElementById('mobile-more-menu').classList.add('hidden');
        }

        // ==================== UTILITIES ====================
        let currentNoteCategory = 'üìö';
        let currentFilterCategory = 'all';
        
        function quickNote() {
            openAddNoteModal();
        }
        
        function openAddNoteModal() {
            document.getElementById('new-note-text').value = '';
            currentNoteCategory = 'üìö';
            document.querySelectorAll('.new-note-cat').forEach(btn => {
                btn.classList.remove('border-white', 'border-2');
                if (btn.dataset.cat === 'üìö') btn.classList.add('border-white', 'border-2');
            });
            document.getElementById('add-note-modal').style.display = 'flex';
            document.getElementById('new-note-text').focus();
            lucide.createIcons();
        }
        
        function closeAddNoteModal() {
            document.getElementById('add-note-modal').style.display = 'none';
        }
        
        function selectNoteCategory(cat) {
            currentNoteCategory = cat;
            document.querySelectorAll('.new-note-cat').forEach(btn => {
                btn.classList.remove('border-white', 'border-2');
                if (btn.dataset.cat === cat) btn.classList.add('border-white', 'border-2');
            });
        }
        
        function saveNewNote() {
            const text = document.getElementById('new-note-text').value.trim();
            if (!text) {
                playAlertSound();
                showToast('‚ö†Ô∏è Note vide!');
                return;
            }
            
            db.notes.push({ 
                text: text, 
                category: currentNoteCategory,
                date: new Date().toISOString() 
            });
            save();
            playNotificationSound();
            showToast('üìù Note enregistr√©e');
            closeAddNoteModal();
            renderNotes();
        }
        
        function openNotesModal() {
            currentFilterCategory = 'all';
            document.getElementById('notes-search').value = '';
            updateCategoryButtons();
            renderNotes();
            document.getElementById('notes-modal').style.display = 'flex';
            lucide.createIcons();
        }
        
        function closeNotesModal() {
            document.getElementById('notes-modal').style.display = 'none';
        }
        
        function filterByCategory(cat) {
            currentFilterCategory = cat;
            updateCategoryButtons();
            renderNotes();
        }
        
        function updateCategoryButtons() {
            document.querySelectorAll('.note-cat-btn').forEach(btn => {
                btn.classList.remove('active', 'ring-2', 'ring-white');
                if (btn.dataset.cat === currentFilterCategory) {
                    btn.classList.add('active', 'ring-2', 'ring-white');
                }
            });
        }
        
        function filterNotes() {
            renderNotes();
        }
        
        function renderNotes() {
            const container = document.getElementById('notes-list');
            if (!container) return;
            
            const searchTerm = (document.getElementById('notes-search')?.value || '').toLowerCase();
            
            // Filter notes
            let filteredNotes = db.notes.filter(note => {
                const matchesSearch = note.text.toLowerCase().includes(searchTerm);
                const matchesCategory = currentFilterCategory === 'all' || note.category === currentFilterCategory;
                return matchesSearch && matchesCategory;
            });
            
            if (filteredNotes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <i data-lucide="sticky-note" class="w-16 h-16 mx-auto mb-4 opacity-30"></i>
                        <p class="font-bold">${db.notes.length === 0 ? 'Aucune note' : 'Aucun r√©sultat'}</p>
                        <p class="text-sm mt-2">${db.notes.length === 0 ? 'Clique sur "Nouvelle Note" pour commencer' : 'Essaie un autre filtre'}</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            // Afficher les notes de la plus r√©cente √† la plus ancienne
            const sortedNotes = [...filteredNotes].reverse();
            
            container.innerHTML = sortedNotes.map((note) => {
                const realIndex = db.notes.findIndex(n => n.date === note.date && n.text === note.text);
                const date = new Date(note.date);
                const dateStr = date.toLocaleDateString('fr-FR', { 
                    day: 'numeric', 
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const catColors = {
                    'üìö': 'bg-indigo-500/20 text-indigo-400',
                    'üí°': 'bg-amber-500/20 text-amber-400',
                    '‚ù§Ô∏è': 'bg-pink-500/20 text-pink-400',
                    '‚ö°': 'bg-emerald-500/20 text-emerald-400'
                };
                const catClass = catColors[note.category] || 'bg-white/10';
                
                return `
                    <div class="glass p-4 hover:bg-white/5 group">
                        <div class="flex justify-between items-start gap-4">
                            <div class="flex-1">
                                <span class="inline-block px-2 py-1 rounded-full text-[10px] font-bold ${catClass} mb-2">${note.category || 'üìù'}</span>
                                <p class="text-sm">${escapeHtml(note.text)}</p>
                            </div>
                            <button onclick="deleteNote(${realIndex})" class="opacity-0 group-hover:opacity-100 p-2 hover:bg-red-500/20 rounded-lg text-red-400 transition touch-feedback">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <p class="text-[10px] text-slate-500 mt-2">${dateStr}</p>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        function deleteNote(index) {
            if (index < 0 || index >= db.notes.length) return;
            db.notes.splice(index, 1);
            save();
            renderNotes();
            showToast('üóëÔ∏è Note supprim√©e');
        }
        
        function clearAllNotes() {
            if (db.notes.length === 0) {
                showToast('Aucune note √† supprimer');
                return;
            }
            if (!confirm('Supprimer toutes les notes ?')) return;
            db.notes = [];
            save();
            renderNotes();
            showToast('üóëÔ∏è Toutes les notes supprim√©es');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==================== FOCUS HISTORY ====================
        function openFocusHistory() {
            renderFocusHistory();
            document.getElementById('focus-history-modal').style.display = 'flex';
            lucide.createIcons();
        }
        
        function closeFocusHistory() {
            document.getElementById('focus-history-modal').style.display = 'none';
        }
        
        function renderFocusHistory() {
            const container = document.getElementById('focus-history-list');
            if (!container) return;
            
            // Stats
            const totalSessions = db.focusSessions.length;
            const totalMinutes = db.focusSessions.reduce((sum, s) => sum + (s.duration || 25), 0);
            const avgDuration = totalSessions > 0 ? Math.round(totalMinutes / totalSessions) : 0;
            
            document.getElementById('focus-total-sessions').textContent = totalSessions;
            document.getElementById('focus-total-hours').textContent = Math.floor(totalMinutes / 60) + 'h' + (totalMinutes % 60 > 0 ? totalMinutes % 60 + 'm' : '');
            document.getElementById('focus-avg-duration').textContent = avgDuration + 'm';
            
            if (totalSessions === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <i data-lucide="target" class="w-16 h-16 mx-auto mb-4 opacity-30"></i>
                        <p class="font-bold">Aucune session</p>
                        <p class="text-sm mt-2">Lance ton premier Pomodoro!</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            // Group by date
            const grouped = {};
            db.focusSessions.forEach(session => {
                const dateKey = new Date(session.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(session);
            });
            
            // Render
            container.innerHTML = Object.entries(grouped).reverse().map(([date, sessions]) => {
                const dayTotal = sessions.reduce((sum, s) => sum + (s.duration || 25), 0);
                return `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <p class="font-bold text-sm capitalize">${date}</p>
                            <span class="text-[10px] text-indigo-400 font-bold">${sessions.length} sessions ‚Ä¢ ${dayTotal}min</span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${sessions.map(s => {
                                const time = new Date(s.date).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                                return `<span class="px-3 py-1 bg-indigo-500/20 text-indigo-400 rounded-full text-[10px] font-bold">${time} ‚Ä¢ ${s.duration || 25}m</span>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function showToast(msg, withSound = false) {
            const toast = document.getElementById('toast');
            const text = document.getElementById('toast-text');
            
            if (!toast || !text) return;
            
            text.textContent = msg;
            toast.style.transform = 'translateY(0) translateX(-50%)';
            toast.style.opacity = '1';
            
            // Jouer un son selon le type de message
            if (withSound) {
                if (msg.includes('üéâ') || msg.includes('‚ú®') || msg.includes('NIVEAU') || msg.includes('Sagesse')) {
                    playSuccessSound();
                } else if (msg.includes('üö®') || msg.includes('ALERTE') || msg.includes('‚ùå')) {
                    playAlertSound();
                } else {
                    playNotificationSound();
                }
            }
            
            lucide.createIcons();
            
            setTimeout(() => {
                toast.style.transform = 'translateY(8rem) translateX(-50%)';
                toast.style.opacity = '0';
            }, 3000);
        }

        function save() { 
            StateManager.update(db);
        }
        
        // ==================== TEMPLATES PLANNING ====================
        const PLANNING_TEMPLATES = {
            normal: {
                name: 'Semaine Type',
                slots: {
                    "1-9": { name: "Cours", type: "cours" },
                    "1-10": { name: "Cours", type: "cours" },
                    "1-14": { name: "TD", type: "cours" },
                    "2-9": { name: "Cours", type: "cours" },
                    "2-14": { name: "R√©visions", type: "revisions" },
                    "3-9": { name: "Cours", type: "cours" },
                    "3-10": { name: "Cours", type: "cours" },
                    "4-9": { name: "Cours", type: "cours" },
                    "4-14": { name: "Sport", type: "sport" },
                    "5-9": { name: "Cours", type: "cours" },
                    "5-14": { name: "R√©visions", type: "revisions" },
                    "6-10": { name: "D√©tente", type: "repos" }
                }
            },
            exam: {
                name: 'Semaine Examens',
                slots: {
                    "1-8": { name: "R√©visions", type: "revisions" },
                    "1-9": { name: "R√©visions", type: "revisions" },
                    "1-10": { name: "R√©visions", type: "revisions" },
                    "1-14": { name: "Pause", type: "repos" },
                    "1-15": { name: "R√©visions", type: "revisions" },
                    "1-16": { name: "R√©visions", type: "revisions" },
                    "2-8": { name: "R√©visions", type: "revisions" },
                    "2-9": { name: "R√©visions", type: "revisions" },
                    "2-10": { name: "R√©visions", type: "revisions" },
                    "2-14": { name: "Pause", type: "repos" },
                    "2-15": { name: "R√©visions", type: "revisions" },
                    "3-8": { name: "R√©visions", type: "revisions" },
                    "3-9": { name: "R√©visions", type: "revisions" },
                    "3-14": { name: "Sport", type: "sport" },
                    "4-8": { name: "R√©visions", type: "revisions" },
                    "4-9": { name: "R√©visions", type: "revisions" },
                    "5-8": { name: "R√©visions", type: "revisions" },
                    "5-9": { name: "R√©visions", type: "revisions" }
                }
            },
            light: {
                name: 'Semaine Light',
                slots: {
                    "1-10": { name: "Travail", type: "revisions" },
                    "1-11": { name: "Travail", type: "revisions" },
                    "2-10": { name: "Travail", type: "revisions" },
                    "3-10": { name: "Travail", type: "revisions" },
                    "4-14": { name: "Sport", type: "sport" },
                    "5-10": { name: "Travail", type: "revisions" },
                    "6-10": { name: "Loisirs", type: "repos" },
                    "7-10": { name: "Repos", type: "repos" }
                }
            }
        };
        
        function applyTemplate(templateName) {
            const template = PLANNING_TEMPLATES[templateName];
            if (!template) return;
            
            if (!confirm(`Appliquer "${template.name}"? Cela remplacera le planning actuel.`)) return;
            
            db.timetable = {};
            Object.entries(template.slots).forEach(([key, slot]) => {
                db.timetable[key] = { 
                    ...slot, 
                    id: Helpers.genId(),
                    createdAt: new Date().toISOString()
                };
            });
            
            save();
            renderGrid();
            refreshAll();
            playSuccessSound();
            showToast(`‚úÖ Template "${template.name}" appliqu√©`);
        }
        
        function saveAsTemplate() {
            const name = prompt('Nom du template:');
            if (!name) return;
            
            db.templates[name.toLowerCase().replace(/\s+/g, '_')] = {
                name: name,
                slots: { ...db.timetable },
                createdAt: new Date().toISOString()
            };
            save();
            showToast(`üíæ Template "${name}" sauvegard√©`);
        }
        
        function duplicateToNextWeek() {
            // Juste un message pour l'instant, la logique compl√®te n√©cessiterait
            // un syst√®me de dates dans le planning
            showToast('üìÖ Fonctionnalit√© √† venir: calendrier multi-semaines');
        }
        
        function toggleTemplateMenu() {
            const menu = document.getElementById('template-menu');
            menu.classList.toggle('hidden');
        }
        
        // Fermer le menu si on clique ailleurs
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('template-menu');
            if (menu && !e.target.closest('#template-menu') && !e.target.closest('[onclick*="toggleTemplateMenu"]')) {
                menu.classList.add('hidden');
            }
        });

        function addDemoData() {
            db.timetable = {
                "1-9": { name: "√âconomie", type: "cours" },
                "1-10": { name: "√âconomie", type: "cours" },
                "2-11": { name: "R√©vision", type: "revisions" },
                "3-9": { name: "Droit", type: "cours" },
                "3-14": { name: "Projet", type: "revisions" },
                "4-15": { name: "Sport", type: "repos" },
                "5-10": { name: "Amphi", type: "cours" },
                "6-10": { name: "Perso", type: "repos" }
            };
            db.logs = [
                { day: "Lun", stress: 3, sleep: 8, mood: 'üòä', date: new Date(Date.now() - 4*24*60*60*1000).toISOString() },
                { day: "Mar", stress: 5, sleep: 7, mood: 'üòê', date: new Date(Date.now() - 3*24*60*60*1000).toISOString() },
                { day: "Mer", stress: 7, sleep: 6.5, mood: 'üòê', date: new Date(Date.now() - 2*24*60*60*1000).toISOString() },
                { day: "Jeu", stress: 6, sleep: 7, mood: 'üòä', date: new Date(Date.now() - 1*24*60*60*1000).toISOString() },
                { day: "Ven", stress: 4, sleep: 8, mood: 'üòÑ', date: new Date().toISOString() }
            ];
            db.gamification = { level: 3, wisdom: 280, streak: 5, lastEntry: new Date().toISOString().slice(0,10) };
            db.goals = [
                { text: 'R√©viser chapitre 3', category: '√âtudes', completed: true },
                { text: 'Dormir 8h ce soir', category: 'Sant√©', completed: false },
                { text: 'Faire 30min de sport', category: 'Sant√©', completed: false }
            ];
            save(); 
            renderGrid(); 
            refreshAll(); 
            updateGamification();
            renderGoals();
            updateAnalytics();
            showToast('üéÆ Donn√©es d√©mo charg√©es');
        }

        function resetAll() {
            if (!confirm('‚ö†Ô∏è Supprimer TOUTES les donn√©es ?')) return;
            if (!confirm('Cette action est IRR√âVERSIBLE. Confirmer ?')) return;
            localStorage.removeItem('sf_ultimate_pro');
            localStorage.removeItem(CONFIG.STORAGE_KEY);
            showToast('üóëÔ∏è Donn√©es supprim√©es');
            setTimeout(() => location.reload(), 1500);
        }
        
        // ==================== PWA & RAPPELS MANQU√âS ====================
        // V√©rifier les rappels manqu√©s au chargement
        function checkMissedReminders() {
            const lastVisit = localStorage.getItem('sf_last_visit');
            const now = Date.now();
            
            if (lastVisit) {
                const elapsed = now - parseInt(lastVisit);
                const hoursMissed = Math.floor(elapsed / (1000 * 60 * 60));
                
                if (hoursMissed >= 1 && db.settings.notifications) {
                    const missedWater = Math.floor(elapsed / (45 * 60 * 1000));
                    const missedEyes = Math.floor(elapsed / (20 * 60 * 1000));
                    
                    if (missedWater > 0 || missedEyes > 0) {
                        setTimeout(() => {
                            showToast(`‚è∞ Rappels manqu√©s: ${missedWater} hydratation, ${missedEyes} pause yeux`);
                        }, 2000);
                    }
                }
            }
            
            localStorage.setItem('sf_last_visit', now.toString());
        }
        
        // Enregistrer le Service Worker si disponible
        if ('serviceWorker' in navigator) {
            // Service Worker inline via Blob
            const swCode = `
                const CACHE_NAME = 'studentflow-v2';
                const urlsToCache = ['/'];
                
                self.addEventListener('install', event => {
                    self.skipWaiting();
                });
                
                self.addEventListener('activate', event => {
                    event.waitUntil(clients.claim());
                });
                
                self.addEventListener('fetch', event => {
                    // Network first, then cache
                    event.respondWith(
                        fetch(event.request).catch(() => caches.match(event.request))
                    );
                });
            `;
            
            const swBlob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(swBlob);
            
            // Note: Les Service Workers depuis Blob ne fonctionnent pas dans tous les navigateurs
            // Pour une vraie PWA, il faudrait un fichier sw.js s√©par√©
            // navigator.serviceWorker.register(swUrl).catch(() => {});
        }
        
        // V√©rifier les rappels au chargement
        checkMissedReminders();
        
        // Mettre √† jour le titre si Pomodoro actif
        setInterval(() => {
            if (!pomodoroActive) {
                document.title = 'StudentFlow Ultimate Pro';
            }
        }, 60000);
    </script>
</body>
</html>
